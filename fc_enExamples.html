<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>英単語・例文 フラッシュカード</title>
  <style>
    :root{ --bg:#0f172a; --panel:#0a0f1a; --card:#0b1220; --border:#1f2937; --fg:#e5e7eb; --muted:#9ca3af; --acc:#22d3ee; --answer:#7CFFB2; }
    html, body{ height:100%; margin:0; background: linear-gradient( rgba(5, 8, 20, 0.75), rgba(5, 8, 20, 0.9)), url("img/bg_fc_enExamples.png"); background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: fixed; font-family: system-ui,-apple-system,Segoe UI,Roboto, "Hiragino Kaku Gothic ProN",Meiryo,sans-serif; }
    .container{max-width:960px; margin:0 auto; padding:16px 16px 64px;}
    header{display:flex; gap:12px; align-items:center; justify-content:space-between; color:var(--fg); margin-top:12px; flex-wrap:wrap}
    header .title{font-weight:800; letter-spacing:.3px; white-space:normal; word-break:break-word; line-height:1.25}
    .meta{display:flex; gap:14px; align-items:center; color:var(--muted); font-size:13px}
    .controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    button{background:#0a1322; color:var(--fg); border:1px solid var(--border); border-radius:12px; padding:10px 14px; font-weight:800; cursor:pointer}
    button:hover{border-color:#2b3a55}

    .card{margin-top:14px; background:linear-gradient(180deg,#0a1322,#0a0f1a); border:1px solid var(--border); border-radius:20px; padding:24px; display:grid; grid-template-columns:1fr; gap:16px; align-items:start; box-shadow:0 10px 30px rgba(0,0,0,.35);}    
    .term-mean{display:flex; align-items:baseline; gap:12px; flex-wrap:wrap}
    .term{line-height:1.2;}
    .phrases{display:flex; flex-direction:column; gap:8px}
    .phrase-line{display:flex; flex-direction:column; gap:2px; align-items:flex-start}
    .phrase-ja{line-height:1.4; min-height:1.4em}
    .q-text,.a-text{font-size:clamp(18px,3.6vw,24px); font-weight:700;}
    .question{color:var(--muted);}
    .question.is-active{color:var(--fg);}
    .answer{color:var(--answer);}
    .answer.is-hidden{visibility:hidden;}

    a.back{color:var(--acc); text-decoration:none; font-size:14px}

    @media (max-width: 640px){
      .container{padding:12px 12px 56px;}
      .card{padding:18px; border-radius:16px}
      button{padding:10px 12px}
    }
  </style>

  <!-- files.js を「普通の script」として先に読み込む（export無しでも使えるように） -->
  <script src="en_examples/files.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <div class="title">英単語・例文 フラッシュカード</div>
        <div class="meta">
          <span id="categoryLabel">カテゴリ: --</span>
          <span id="expLabel">EXP: 0</span>
        </div>
      </div>
      <div class="controls" aria-label="dataset controls">
        <button id="randomBtn" type="button">ランダムでカテゴリーを選んでカードを表示</button>
      </div>
    </header>

    <section class="card" aria-live="polite" id="card" tabindex="0">
      <div class="term-mean">
        <div class="term question q-text" id="term">...</div>
        <div class="mean answer a-text is-hidden" id="meaning"></div>
      </div>
      <div class="phrases" id="phrases"></div>
    </section>
  </div>
  <div style="padding:16px; max-width:960px; margin:0 auto"><a class="back" href="index.html">戻る</a></div>

  <script>
  // ============================
  // Loader: en_examples/* を読み込んで dataset[] に変換
  // 期待する各ファイルの形式（例）：
  //   const enExamples_astronomy = { "planet": { ja:"惑星", examples:[{en,ja},...] }, ... }
  // files.js：
  //   const files_enExamples = ["astronomy.js", ...]
  // ============================

  const STUB_EN_EXAMPLES = {
    planet: {
      ja: "惑星",
      examples: [
        { en: "a rocky planet", ja: "岩石惑星" },
        { en: "clear its orbital neighborhood", ja: "軌道近傍を一掃する" },
        { en: "in the habitable zone", ja: "ハビタブルゾーン内で" },
      ],
    },
  };

  const EXP_KEY = "midunohi.exam.exp";

  function loadExp(){
    try{
      const raw = localStorage.getItem(EXP_KEY);
      const n = Number(raw || 0);
      return Number.isFinite(n) && n >= 0 ? Math.floor(n) : 0;
    }catch(_){
      return 0;
    }
  }

  function saveExp(){
    try{ localStorage.setItem(EXP_KEY, String(exp)); }catch(_){ /* noop */ }
  }

  let exp = loadExp();
  let currentCategory = '--';

  function safeGlobalEval(name){
    // グローバルレキシカル環境（const）から取り出すための global eval
    try{ return (0, eval)(name); }catch(_){ return undefined; }
  }

  function ensureMinPhrases(phrases, n=3){
    const out = Array.isArray(phrases) ? phrases.slice(0) : [];
    while(out.length < n) out.push({en:"", ja:""});
    return out;
  }

  function toDataset(enExamplesObj){
    if(!enExamplesObj || typeof enExamplesObj !== 'object') return [];
    const entries = Object.entries(enExamplesObj);
    const items = entries.map(([en, v])=>{
      const ja = v?.ja ?? "";
      const examples = v?.examples ?? v?.phrases ?? v?.ex ?? [];
      const phrases = ensureMinPhrases(
        examples.map(p => ({ en: String(p?.en ?? ""), ja: String(p?.ja ?? "") }))
      );
      return { en, ja, phrases };
    });
    // 空要素を除外
    return items.filter(x => x.en && (x.ja || x.phrases.some(p=>p.en||p.ja)));
  }

  function injectScript(src){
    return new Promise((resolve, reject)=>{
      const s = document.createElement('script');
      s.src = src;
      s.async = true;
      s.onload = ()=>resolve(true);
      s.onerror = ()=>reject(new Error('load failed: '+src));
      document.head.appendChild(s);
    });
  }

  async function loadEnExamplesFile(filename){
    const base = filename.replace(/\.js$/,'');
    const globalName = `enExamples_${base}`;
    const src = `en_examples/${filename}`;

    try{
      await injectScript(src);
      const obj = safeGlobalEval(globalName);
      if(!obj) throw new Error(`global not found: ${globalName}`);
      return { ok:true, name:base, obj };
    }catch(err){
      console.warn(err);
      return { ok:false, name:base, obj:STUB_EN_EXAMPLES, err };
    }
  }

  function getFiles(){
    const files = (typeof files_enExamples !== 'undefined' && Array.isArray(files_enExamples))
      ? files_enExamples
      : ["astronomy.js"];
    return files.length ? files : ["astronomy.js"];
  }

  function pickRandomIndex(len, except){
    if(len <= 1) return 0;
    let n = 0;
    do{ n = Math.floor(Math.random() * len); }while(n === except);
    return n;
  }

  function getRevealTotal(item){
    let total = 0;
    if(item.ja) total += 1;
    (item.phrases || []).forEach(p=>{ if(p.ja) total += 1; });
    return total;
  }

  // ============================
  // Flashcards Core
  // ============================

  let dataset = []; // 動的にセット
  let idx = 0;
  let revealStep = 0;

  // --- Elements --------------------------------------------------------
  const els = {
    term: document.getElementById('term'),
    meaning: document.getElementById('meaning'),
    phrases: document.getElementById('phrases'),
    card: document.getElementById('card'),
    categoryLabel: document.getElementById('categoryLabel'),
    expLabel: document.getElementById('expLabel'),
    randomBtn: document.getElementById('randomBtn')
  };

  // --- Rendering -------------------------------------------------------
  function updateMeta(){
    els.categoryLabel.textContent = `カテゴリ: ${currentCategory}`;
    els.expLabel.textContent = `EXP: ${exp}`;
  }

  function render(){
    if(!dataset.length){
      els.term.textContent = '…';
      els.meaning.textContent = '';
      els.meaning.classList.add('is-hidden');
      els.phrases.innerHTML = '';
      updateMeta();
      return;
    }

    const item = dataset[idx];
    els.term.textContent = item.en;
    els.meaning.textContent = item.ja || '';

    const meaningVisible = item.ja && revealStep >= 1;
    els.meaning.classList.toggle('is-hidden', !meaningVisible);

    els.phrases.innerHTML = '';

    let step = item.ja ? 1 : 0;
    const questionEls = [];
    questionEls.push(els.term);
    (item.phrases || []).forEach((p, i) => {
      const line = document.createElement('div');
      line.className = 'phrase-line';
      const en = document.createElement('div');
      en.className = 'phrase-en question q-text';
      en.textContent = p.en;
      const ja = document.createElement('div');
      ja.className = 'phrase-ja answer a-text';
      ja.textContent = p.ja;
      let jaVisible = false;
      if(p.ja){
        step += 1;
        jaVisible = revealStep >= step;
      }
      ja.classList.toggle('is-hidden', !jaVisible);
      line.appendChild(en);
      line.appendChild(ja);
      els.phrases.appendChild(line);
      questionEls.push(en);
    });

    const total = getRevealTotal(item);
    if(total === 0 || revealStep >= total){
      questionEls.forEach(el => el.classList.add('is-active'));
    }else{
      questionEls.forEach(el => el.classList.remove('is-active'));
      const activeIndex = Math.min(revealStep, questionEls.length - 1);
      questionEls[activeIndex].classList.add('is-active');
    }
    updateMeta();
  }

  // --- Actions ---------------------------------------------------------
  function gainExp(n){
    exp += n;
    saveExp();
    updateMeta();
  }

  function nextCard(){
    idx = pickRandomIndex(dataset.length, idx);
    revealStep = 0;
    render();
  }

  function advance(){
    if(!dataset.length) return;
    const item = dataset[idx];
    const total = getRevealTotal(item);

    if(total === 0){
      gainExp(1);
      nextCard();
      return;
    }

    if(revealStep < total){
      revealStep += 1;
      render();
      return;
    }

    gainExp(1);
    nextCard();
  }

  // --- Events ----------------------------------------------------------
  els.card.addEventListener('click', advance);

  window.addEventListener('keydown', e=>{
    if(['Space','Enter'].includes(e.code)) e.preventDefault();
    if(e.code==='Space' || e.code==='Enter') advance();
  }, {passive:false});

  // ============================
  // Boot
  // ============================

  async function loadRandomCategory(){
    const files = getFiles();
    const filename = files[Math.floor(Math.random() * files.length)];
    currentCategory = filename.replace(/\.js$/,'');

    els.term.textContent = 'loading…';
    els.meaning.textContent = '';
    els.meaning.classList.add('is-hidden');
    els.phrases.innerHTML = '';

    const res = await loadEnExamplesFile(filename);
    dataset = toDataset(res.obj);
    if(!dataset.length){
      dataset = toDataset(STUB_EN_EXAMPLES);
    }

    idx = pickRandomIndex(dataset.length, -1);
    revealStep = 0;
    render();
  }

  function boot(){
    els.randomBtn.addEventListener('click', loadRandomCategory);
    loadRandomCategory();
  }

  boot();
  </script>
</body>
</html>
