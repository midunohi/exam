<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>英単語帳ビューア</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.5;
      color: #222;
      background: #f5f5f7;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top left, #eef, #f5f5f7);
    }

    #app {
      max-width: 960px;
      margin: 0 auto;
      padding: 1.5rem 1.25rem 3rem;
    }

    header {
      margin-bottom: 1.5rem;
    }

    header h1 {
      margin: 0 0 0.25rem;
      font-size: 1.4rem;
    }

    header p {
      margin: 0;
      font-size: 0.9rem;
      color: #555;
    }

    .panel {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
      padding: 1rem 1.25rem;
      margin-bottom: 1rem;
    }

    #controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.9rem;
    }

    #controls label {
      font-weight: 600;
    }

    select, button {
      font: inherit;
      border-radius: 999px;
      border: 1px solid #ccc;
      padding: 0.35rem 0.85rem;
      background: #fff;
    }

    button {
      cursor: pointer;
      border: 1px solid #4463ff;
      background: #4463ff;
      color: #fff;
      font-weight: 600;
    }

    button:hover {
      filter: brightness(1.05);
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    #status {
      font-size: 0.75rem;
      color: #666;
    }

    #status span.tag {
      display: inline-block;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      margin-left: 0.25rem;
      background: #eef;
      color: #334;
    }

    #wordList {
      margin-top: 0.75rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 0.75rem;
    }

    .word-card {
      background: #fff;
      border-radius: 12px;
      padding: 0.75rem 0.9rem;
      border: 1px solid #e3e3ee;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
    }

    .word-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
    }

    .word-headword {
      font-weight: 700;
      font-size: 1rem;
    }

    .word-pos {
      font-size: 0.75rem;
      color: #666;
    }

    .word-meaning {
      margin-top: 0.2rem;
      font-size: 0.85rem;
    }

    .section-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: #888;
      margin-top: 0.35rem;
    }

    .examples, .phrases {
      margin: 0.2rem 0 0;
      padding-left: 1.1rem;
      font-size: 0.8rem;
      color: #444;
    }

    .examples li + li,
    .phrases li + li {
      margin-top: 0.15rem;
    }

    .notes {
      margin-top: 0.25rem;
      font-size: 0.75rem;
      color: #777;
      border-top: 1px dashed #eee;
      padding-top: 0.25rem;
    }

    .badge {
      display: inline-block;
      font-size: 0.68rem;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      background: #eef5ff;
      color: #345;
    }

    @media (max-width: 640px) {
      #app {
        padding: 1rem 0.75rem 2.5rem;
      }

      #wordList {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>英単語帳ビューア</h1>
      <p>通常環境では <code>di/&lt;カテゴリ名&gt;.json</code> を fetch し、Canvas 環境ではダミーデータを利用します。</p>
    </header>

    <section class="panel" id="controls">
      <label for="categorySelect">カテゴリ:</label>
      <select id="categorySelect">
        <option value="existence">existence（存在・実体）</option>
        <!-- 将来 quantity などを追加可能 -->
      </select>
      <button id="reloadBtn">読み込み</button>
      <div id="status"></div>
    </section>

    <section class="panel">
      <div id="categoryMeta" style="font-size:0.85rem;color:#555;margin-bottom:0.5rem;"></div>
      <div id="wordList"></div>
    </section>
  </div>

  <script>
    // ---- ダミーデータ（ChatGPT Canvas / ファイルが無い環境用） ----
    const dummyDataByCategory = {
      existence: {
        categories: [
          {
            id: "existence",
            name_ja: "存在・実体",
            name_en: "Existence / Entity",
            words: [
              {
                headword: "existence",
                pos: "noun",
                meaning_ja: "存在",
                examples: [
                  { en: "The existence of water is essential for life.", ja: "水の存在は生命にとって不可欠だ。" }
                ],
                phrases: ["come into existence"],
                notes: "abstract noun, often used with 'of'"
              },
              {
                headword: "entity",
                pos: "noun",
                meaning_ja: "実体、存在",
                examples: [
                  { en: "Each company is a separate legal entity.", ja: "それぞれの会社は別個の法的実体である。" }
                ],
                phrases: ["independent entity"],
                notes: "often used in legal or philosophical context"
              },
            ]
          }
        ]
      }
    };

    const categorySelect = document.getElementById("categorySelect");
    const reloadBtn = document.getElementById("reloadBtn");
    const statusEl = document.getElementById("status");
    const wordListEl = document.getElementById("wordList");
    const categoryMetaEl = document.getElementById("categoryMeta");

    function setStatus(text, tag) {
      statusEl.innerHTML = "";
      if (!text && !tag) return;
      const spanText = document.createElement("span");
      spanText.textContent = text;
      statusEl.appendChild(spanText);
      if (tag) {
        const spanTag = document.createElement("span");
        spanTag.className = "tag";
        spanTag.textContent = tag;
        statusEl.appendChild(spanTag);
      }
    }

    function clearWordList() {
      while (wordListEl.firstChild) wordListEl.removeChild(wordListEl.firstChild);
    }

    function renderCategory(data, categoryId) {
      clearWordList();

      let category = null;
      if (data && Array.isArray(data.categories)) {
        category = data.categories.find(c => c.id === categoryId) || data.categories[0];
      } else if (data && data.words) {
        category = data;
      }

      if (!category) {
        categoryMetaEl.textContent = "カテゴリデータが見つかりません。";
        return;
      }

      const { name_ja, name_en, words } = category;
      categoryMetaEl.innerHTML = `
        <span class="badge">${categoryId}</span>
        <strong style="margin-left:0.4rem;">${name_ja || ""}</strong>
        <span style="margin-left:0.3rem;color:#777;">${name_en || ""}</span>
        <span style="margin-left:0.6rem;font-size:0.75rem;color:#777;">単語数: ${words ? words.length : 0}</span>
      `;

      if (!Array.isArray(words) || words.length === 0) {
        const p = document.createElement("p");
        p.textContent = "このカテゴリには単語が登録されていません。";
        p.style.fontSize = "0.9rem";
        wordListEl.appendChild(p);
        return;
      }

      for (const w of words) {
        const card = document.createElement("article");
        card.className = "word-card";

        const header = document.createElement("div");
        header.className = "word-header";

        const headwordEl = document.createElement("div");
        headwordEl.className = "word-headword";
        headwordEl.textContent = w.headword;

        const posEl = document.createElement("div");
        posEl.className = "word-pos";
        posEl.textContent = w.pos || "";

        header.appendChild(headwordEl);
        header.appendChild(posEl);

        const meaningEl = document.createElement("div");
        meaningEl.className = "word-meaning";
        meaningEl.textContent = w.meaning_ja || "";

        card.appendChild(header);
        card.appendChild(meaningEl);

        if (Array.isArray(w.examples) && w.examples.length > 0) {
          const label = document.createElement("div");
          label.className = "section-label";
          label.textContent = "Examples";
          card.appendChild(label);

          const ul = document.createElement("ul");
          ul.className = "examples";
          for (const ex of w.examples) {
            const li = document.createElement("li");
            const enSpan = document.createElement("span");
            enSpan.textContent = ex.en;
            const br = document.createElement("br");
            const jaSpan = document.createElement("span");
            jaSpan.style.color = "#666";
            jaSpan.textContent = ex.ja;
            li.appendChild(enSpan);
            li.appendChild(br);
            li.appendChild(jaSpan);
            ul.appendChild(li);
          }
          card.appendChild(ul);
        }

        if (Array.isArray(w.phrases) && w.phrases.length > 0) {
          const label = document.createElement("div");
          label.className = "section-label";
          label.textContent = "Phrases";
          card.appendChild(label);

          const ul = document.createElement("ul");
          ul.className = "phrases";
          for (const ph of w.phrases) {
            const li = document.createElement("li");
            li.textContent = ph;
            ul.appendChild(li);
          }
          card.appendChild(ul);
        }

        if (w.notes) {
          const notesEl = document.createElement("div");
          notesEl.className = "notes";
          notesEl.textContent = w.notes;
          card.appendChild(notesEl);
        }

        wordListEl.appendChild(card);
      }
    }

    function getCategoryUrl(categoryId) {
      return `dic/${categoryId}.json`;
    }

    async function loadCategoryList() {
      const sel = document.getElementById("categorySelect");
      sel.innerHTML = ""; // 初期化

      try {
        const res = await fetch("dic/categories.json", { cache: "no-store" });
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const data = await res.json();

        for (const name of data.files) {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        }

        setStatus("dic/categories.json からカテゴリ一覧を読み込みました。", "fetch");
      } catch (err) {
        // 失敗したらダミーデータ側のキーからカテゴリ一覧を作る（Canvas / ローカル用）
        const fileList = Object.keys(dummyDataByCategory);
        for (const name of fileList) {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        }
        setStatus("カテゴリ一覧の読み込みに失敗したため、ダミー一覧を使用しています。", "dummy");
      }
    }

    async function loadCategory(categoryId) {
      clearWordList();
      setStatus("読み込み中...", null);
      reloadBtn.disabled = true;

      const url = getCategoryUrl(categoryId);
      let loadedFrom = "remote";

      try {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const data = await res.json();
        renderCategory(data, categoryId);
        setStatus(`${url} から読み込みました。`, "fetch");
      } catch (err) {
        // Canvas やローカルで di/*.json が無い場合などはダミーにフォールバック
        const dummy = dummyDataByCategory[categoryId];
        if (dummy) {
          renderCategory(dummy, categoryId);
          setStatus("ダミーデータを使用しています（Canvas / ローカルテスト用）", "dummy");
        } else {
          setStatus(`データの読み込みに失敗しました: ${String(err)}`, "error");
        }
      } finally {
        reloadBtn.disabled = false;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadCategoryList()
        .then(() => {
          // 成功・失敗どちらでも、とにかく現在の select の値で読み込む
          loadCategory(categorySelect.value);
        })
        .catch(err => {
          // 念のための保険（ここには基本来ない想定）
          console.error(err);
          loadCategory(categorySelect.value);
        });

      reloadBtn.addEventListener("click", () => {
        loadCategory(categorySelect.value);
      });
    });
  </script>
</body>
</html>
