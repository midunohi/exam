<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>フラッシュカード 各科目・暗記事項</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#0f172a; --panel:#0a0f1a; --card:#0b1220; --border:#1f2937; --fg:#e5e7eb; --muted:#9ca3af; --acc:#22d3ee; --answer:#7CFFB2; }
    html, body{ height:100%; margin:0; background: linear-gradient( rgba(5, 8, 20, 0.75), rgba(5, 8, 20, 0.9)), url("../img/bg_fc_enExamples.png"); background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: fixed; font-family: system-ui,-apple-system,Segoe UI,Roboto, "Hiragino Kaku Gothic ProN",Meiryo,sans-serif; color: var(--fg); }
    .page{
      min-height: 100vh;
      width: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 80px 16px 24px;
      box-sizing:border-box;
    }
    .card-panel {
      width: min(960px, 96vw);
      background: linear-gradient(180deg,#0a1322,#0a0f1a);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 22px 24px 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      cursor: pointer;
      position:relative;
    }
    .exp-corner{
      position:absolute;
      right:20px;
      bottom:18px;
      font-size:0.85rem;
      color:var(--muted);
    }
    .topbar{
      position:fixed;
      top:0;
      left:0;
      right:0;
      z-index:10;
      padding: 8px 16px;
      display:flex;
      justify-content:center;
      background: linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,.4) 60%, transparent);
      backdrop-filter: blur(6px);
    }
    .topbar-inner{
      width: min(960px, 96vw);
      display:flex;
      align-items:center;
      gap:14px;
      flex-wrap: wrap;
    }
    .topbar-inner .spacer{ flex:1; }
    .app-title{
      font-size: clamp(18px,3.6vw,22px);
      font-weight: 800;
      letter-spacing: 0.02em;
    }
    .back-link{
      display:inline-flex;
      align-items:center;
      gap:6px;
      text-decoration:none;
      color: var(--fg);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.85rem;
      font-weight: 700;
      background: #0a1322;
    }
    .back-link:hover{ border-color:#2b3a55; }
    .category-row{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .category-label{
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      color: var(--muted);
      text-transform: uppercase;
    }
    .category-name{
      font-size: clamp(16px,3.2vw,20px);
      font-weight: 800;
      letter-spacing: 0.01em;
      color: var(--fg);
      min-width: 12ch;
      text-align: left;
    }
    .category-count{
      font-size:0.85rem;
      color:var(--muted);
    }
    .progress{
      font-size:0.85rem;
      color:var(--muted);
      margin: 6px 0 0;
    }
    button {
      background: #0a1322;
      color: var(--fg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px 12px;
      font-weight: 700;
      cursor: pointer;
    }
    button:hover { border-color: #2b3a55; }
    #counter { font-size: 0.85rem; color: var(--muted); margin-bottom: 0.75rem; }
    #question { font-size: clamp(18px,3.6vw,24px); line-height: 1.6; font-weight: 700; }
    #answer { margin-top: 0.75rem; font-size: clamp(18px,3.6vw,24px); line-height: 1.6; visibility: hidden; color: var(--answer); font-weight: 700; }
    #hint { margin-top: 1.5rem; font-size: 0.8rem; color: var(--muted); }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="app-title">フラッシュカード 各科目・暗記事項</div>
      <div class="spacer"></div>
      <a class="back-link" href="../index.html" aria-label="戻る">← 戻る</a>
    </div>
  </div>

  <div class="page">
    <div class="card-panel">
      <div class="category-row" aria-label="カテゴリと切り替え">
        <div class="category-label">カテゴリ</div>
        <div id="categoryLabel" class="category-name">--</div>
        <div id="totalCount" class="category-count">全0問</div>
        <button id="randomBtn" type="button">切り替え</button>
      </div>
      <div id="countLabel" class="progress">0 / 10</div>
      <div id="counter"></div>
      <div id="question"></div>
      <div id="answer"></div>
      <div id="hint">タップ：答え表示 → 次のカード</div>
      <div class="exp-corner">EXP: <span id="expLabel">0</span></div>
    </div>
  </div>

  <script src="../qa/files.js"></script>
  <script>
    const cardEl = document.querySelector(".card-panel");
    const countLabelEl = document.getElementById("countLabel");
    const totalCountEl = document.getElementById("totalCount");
    const expLabelEl = document.getElementById("expLabel");
    const qEl = document.getElementById("question");
    const aEl = document.getElementById("answer");
    const randomBtnEl = document.getElementById("randomBtn");
    const categoryLabelEl = document.getElementById("categoryLabel");

    const EXP_KEY = "midunohi.exam.exp";
    let exp = 0;
    let cards = [];   // qa/ 以下の .js から読み込む
    let index = 0;
    let shown = false;
    let currentCategory = "--";
    let cycleCount = 0;
    let answeredCount = 0;
    let currentFileIndex = -1;

    function loadExp() {
      try {
        const stored = localStorage.getItem(EXP_KEY);
        const n = Number(stored || 0);
        exp = Number.isFinite(n) && n >= 0 ? Math.floor(n) : 0;
      } catch (e) {
        exp = 0;
      }
      updateExpDisplay();
    }

    function saveExp() {
      try {
        localStorage.setItem(EXP_KEY, String(exp));
      } catch (e) {
        /* noop */
      }
      updateExpDisplay();
    }

    function updateExpDisplay() {
      if (expLabelEl) expLabelEl.textContent = String(exp);
    }

    function showCard(n) {
      const len = cards.length;
      if (!len) {
        qEl.textContent = "(カードが読み込まれていません)";
        aEl.textContent = "";
        aEl.style.visibility = "hidden";
        countLabelEl.textContent = "0 / 10";
        if (totalCountEl) totalCountEl.textContent = "全0問";
        return;
      }
      index = (n + len) % len;
      const c = cards[index];
      qEl.textContent = c.question || "(question がありません)";
      aEl.textContent = c.answer || "(answer がありません)";
      aEl.style.visibility = "hidden";
      shown = false;
      countLabelEl.textContent = `${cycleCount} / 10`;
      if (totalCountEl) totalCountEl.textContent = `全${len}問`;
    }

    function showRandomCard(exceptIndex = -1) {
      const len = cards.length;
      if (!len) {
        showCard(0);
        return;
      }
      index = pickRandomIndex(len, exceptIndex);
      const c = cards[index];
      qEl.textContent = c.question || "(question がありません)";
      aEl.textContent = c.answer || "(answer がありません)";
      aEl.style.visibility = "hidden";
      shown = false;
      cycleCount = Math.min(cycleCount + 1, 10);
      countLabelEl.textContent = `${cycleCount} / 10`;
      if (totalCountEl) totalCountEl.textContent = `全${len}問`;
    }

    cardEl.addEventListener("click", async () => {
      if (!cards.length) return;
      if (!shown) {
        aEl.style.visibility = "visible";
        shown = true;
      } else {
        exp += 1;
        saveExp();
        answeredCount += 1;
        if (answeredCount % 10 === 0) {
          try {
            currentFileIndex = await loadRandomCategory(currentFileIndex);
          } catch (err) {
            console.error(err);
          }
        } else {
          showRandomCard(index);
        }
      }
    });

    function safeGlobalEval(name) {
      try {
        return (0, eval)(name);
      } catch (_e) {
        return undefined;
      }
    }

    function toCards(raw) {
      if (!Array.isArray(raw)) return [];
      return raw.map((row) => {
        if (Array.isArray(row)) {
          const [question, answer] = row;
          return { question: String(question ?? ""), answer: String(answer ?? "") };
        }
        if (row && typeof row === "object") {
          return {
            question: String(row.question ?? ""),
            answer: String(row.answer ?? ""),
          };
        }
        return { question: "", answer: "" };
      }).filter(c => c.question || c.answer);
    }

    function injectScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.async = true;
        s.onload = () => resolve(true);
        s.onerror = () => reject(new Error(`load failed: ${src}`));
        document.head.appendChild(s);
      });
    }

    function getFiles() {
      const files = (typeof files_qa !== "undefined" && Array.isArray(files_qa)) ? files_qa : [];
      return files.length ? files : ["daily"];
    }

    function pickRandomIndex(len, except) {
      if (len <= 1) return 0;
      let n = 0;
      do { n = Math.floor(Math.random() * len); } while (n === except);
      return n;
    }

    function updateRandomButton() {
      if (!randomBtnEl) return;
      randomBtnEl.textContent = "切り替え";
      if (categoryLabelEl) categoryLabelEl.textContent = `${currentCategory}`;
    }

    async function loadCategory(name) {
      const base = String(name || "").replace(/\.js$/i, "");
      const src = `../qa/${base}.js`;
      const globalName = `qa_${base}`;

      try {
        await injectScript(src);
        const raw = safeGlobalEval(globalName);
        const data = toCards(raw);
        if (!data.length) throw new Error(`qa/${base}.js にカードが見つかりません`);
        cards = data;
        currentCategory = base;
        cycleCount = 0;
        answeredCount = 0;
        updateRandomButton();
        showRandomCard(-1);
      } catch (e) {
        throw new Error(`qa/${base}.js を読み込めませんでした`);
      }
    }

    async function loadRandomCategory(exceptIndex = -1) {
      const files = getFiles();
      const idx = pickRandomIndex(files.length, exceptIndex);
      await loadCategory(files[idx]);
      currentFileIndex = idx;
      return idx;
    }

    async function init() {
      try {
        updateRandomButton();
        await loadRandomCategory(-1);
      } catch (e) {
        console.error(e);
        qEl.textContent = "カード一覧の読み込みに失敗しました";
        aEl.textContent = "qa/files.js と qa/*.js を確認してください";
        aEl.style.visibility = "visible";
        countLabelEl.textContent = "0 / 0";
      }
    }

    let lastFileIndex = -1;
    if (randomBtnEl) {
      randomBtnEl.addEventListener("click", async (e) => {
        e.stopPropagation();
        try {
          lastFileIndex = await loadRandomCategory(lastFileIndex);
        } catch (err) {
          console.error(err);
        }
      });
    }

    loadExp();
    init();
  </script>
</body>
</html>
