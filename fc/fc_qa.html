<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>英単語 フラッシュカード</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#0f172a; --panel:#0a0f1a; --card:#0b1220; --border:#1f2937; --fg:#e5e7eb; --muted:#9ca3af; --acc:#22d3ee; --answer:#7CFFB2; }
    html, body{ height:100%; margin:0; background: linear-gradient( rgba(5, 8, 20, 0.75), rgba(5, 8, 20, 0.9)), url("../img/bg_fc_enExamples.png"); background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: fixed; font-family: system-ui,-apple-system,Segoe UI,Roboto, "Hiragino Kaku Gothic ProN",Meiryo,sans-serif; color: var(--fg); }
    #card {
      max-width: 960px;
      margin: 0 auto;
      padding: 1.5rem 1.25rem 2rem;
      box-sizing: border-box;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      cursor: pointer;
    }
    #counter { font-size: 0.85rem; color: var(--muted); margin-bottom: 0.75rem; }
    #question { font-size: clamp(18px,3.6vw,24px); line-height: 1.6; font-weight: 700; }
    #answer { margin-top: 0.75rem; font-size: clamp(18px,3.6vw,24px); line-height: 1.6; visibility: hidden; color: var(--answer); font-weight: 700; }
    #hint { margin-top: 1.5rem; font-size: 0.8rem; color: var(--muted); }
  </style>
</head>
<body>
  <div id="card">
    <div id="counter"><span id="countLabel">0 / 0</span> ｜ EXP: <span id="expLabel">0</span></div>
    <div id="question"></div>
    <div id="answer"></div>
    <div id="hint">タップ：答え表示 → 次のカード</div>
  </div>

  <script>
    const cardEl = document.getElementById("card");
    const countLabelEl = document.getElementById("countLabel");
    const expLabelEl = document.getElementById("expLabel");
    const qEl = document.getElementById("question");
    const aEl = document.getElementById("answer");

    const EXP_KEY = "midunohi.exam.exp";
    let exp = 0;
    let cards = [];   // qa/ 以下の JSON から読み込む
    let index = 0;
    let shown = false;

    function loadExp() {
      try {
        const stored = localStorage.getItem(EXP_KEY);
        const n = Number(stored || 0);
        exp = Number.isFinite(n) && n >= 0 ? Math.floor(n) : 0;
      } catch (e) {
        exp = 0;
      }
      updateExpDisplay();
    }

    function saveExp() {
      try {
        localStorage.setItem(EXP_KEY, String(exp));
      } catch (e) {
        /* noop */
      }
      updateExpDisplay();
    }

    function updateExpDisplay() {
      if (expLabelEl) expLabelEl.textContent = String(exp);
    }

    function showCard(n) {
      const len = cards.length;
      if (!len) {
        qEl.textContent = "(カードが読み込まれていません)";
        aEl.textContent = "";
        aEl.style.visibility = "hidden";
        countLabelEl.textContent = "0 / 0";
        return;
      }
      index = (n + len) % len;
      const c = cards[index];
      qEl.textContent = c.question || "(question がありません)";
      aEl.textContent = c.answer || "(answer がありません)";
      aEl.style.visibility = "hidden";
      shown = false;
      countLabelEl.textContent = `${index + 1} / ${len}`;
    }

    cardEl.addEventListener("click", () => {
      if (!cards.length) return;
      if (!shown) {
        aEl.style.visibility = "visible";
        shown = true;
      } else {
        exp += 1;
        saveExp();
        showCard(index + 1);
      }
    });

    async function loadCategory(name) {
      const res = await fetch(`../qa/${name}.json`);
      if (!res.ok) throw new Error(`qa/${name}.json を読み込めませんでした`);
      const data = await res.json();
      if (!Array.isArray(data)) throw new Error(`qa/${name}.json の形式が配列ではありません`);
      cards = data;
      showCard(0);
    }

    async function init() {
      try {
        const res = await fetch("../qa/categories.json");
        if (!res.ok) throw new Error("categories.json を読み込めませんでした");
        const cat = await res.json();
        const files = Array.isArray(cat.files) ? cat.files : [];
        const first = files.length ? files[0] : "daily";
        await loadCategory(first);
      } catch (e) {
        console.error(e);
        qEl.textContent = "カード一覧の読み込みに失敗しました";
        aEl.textContent = "qa/categories.json と qa/*.json を確認してください";
        aEl.style.visibility = "visible";
        countLabelEl.textContent = "0 / 0";
      }
    }

    loadExp();
    init();
  </script>
</body>
</html>
