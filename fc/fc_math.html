<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>数学 フラッシュカード</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.7;
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #e5e7eb;
    }

    .page {
      max-width: 960px;
      margin: 0 auto;
      padding: 1.5rem 1rem 3rem;
    }

    header {
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid #1f2937;
    }

    h1 {
      font-size: 1.6rem;
      margin: 0 0 0.25rem;
    }

    .meta {
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .hint {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-top: 0.9rem;
    }

    .flashcard {
      background: #020617;
      border-radius: 0.9rem;
      padding: 1.2rem 1.4rem;
      border: 1px solid #111827;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
      cursor: pointer;
      user-select: none;
    }

    .card-header {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 0.5rem;
    }

    /* タイトルは不要なので非表示にする */
    .card-title {
      display: none;
    }

    .card-body {
      min-height: 120px; /* 解答部分も含めてあらかじめ高さを確保しておく */
      border-radius: 0.75rem;
      background: #020617;
      border: 1px solid #1f2937;
      padding: 0.9rem 1rem;
      white-space: normal;
      font-size: 0.95rem;
      display: flex;
      flex-direction: column;
      align-items: center;      /* 左右中央揃え */
      justify-content: center;  /* 上下中央寄せ */
      text-align: center;       /* テキストも中央揃え */
    }

    .card-face {
      width: 100%;
      display: inline-block;
      white-space: nowrap;   /* 問題文を1行に固定 */
    }

    .card-answer {
      margin-top: 0.75rem;
      padding-top: 0.6rem;
      border-top: 1px dashed #1f2937;
      color: #d1d5db;
      transition: opacity 0.15s ease;
    }

    /* 解答非表示状態でもスペースは維持してレイアウトを変えない */
    .card-answer.is-hidden {
      color: transparent;
      border-color: transparent;
    }

    @media (min-width: 768px) {
      h1 {
        font-size: 1.9rem;
      }
      .page {
        padding: 2rem 1.25rem 3rem;
      }
    }
  </style>

  <!-- MathJax 設定（インライン数式: $...$ や \( ... \) を利用可能に） -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [["$", "$"], ["\\(", "\\)"]]
      },
      svg: {
        fontCache: "global"
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>
<body>
  <div class="page">
    <header>
      <h1>数学 フラッシュカード</h1>
      <div class="meta">EXP: <span id="expDisplay">0</span> ｜ カードをタップで「解答表示 → 次の問題」。解答表示時に 20% の確率で EXP +1</div>
    </header>

    <main>
      <section class="flashcard" id="flashcard">
        <div class="card-header">
          <span id="problemIndex">1</span> / <span id="problemTotal">3</span>
        </div>
        <!-- タイトルは UI には出さないが、要素自体は残しておく -->
        <div class="card-title" id="problemTitle">第1問</div>
        <div class="card-body">
          <div class="card-face" id="problemQuestion">
            2 + 3 = ?
          </div>
          <div class="card-face card-answer is-hidden" id="problemAnswer">
            5
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // EXP 用の設定
    const EXP_KEY = "midunohi.exam.exp";
    let exp = 0;
    const expDisplayEl = document.getElementById("expDisplay");

    function loadExp() {
      try {
        const stored = localStorage.getItem(EXP_KEY);
        if (stored == null) {
          exp = 0;
        } else {
          const n = Number(stored);
          exp = Number.isFinite(n) && n >= 0 ? Math.floor(n) : 0;
        }
      } catch (e) {
        console.warn("EXP を読み込めませんでした", e);
        exp = 0;
      }
      updateExpDisplay();
    }

    function saveExp() {
      try {
        localStorage.setItem(EXP_KEY, String(exp));
      } catch (e) {
        console.warn("EXP を保存できませんでした", e);
      }
      updateExpDisplay();
    }

    function updateExpDisplay() {
      if (expDisplayEl) expDisplayEl.textContent = String(exp);
    }

    // フラッシュカードのデータ（MathJax でレンダリングされるように LaTeX 形式を使用）
    // 問題データ（JS 文字列内なのでバックスラッシュは必ず \\ でエスケープ）
    const problems = [
      { title: "第1問（微分）", question: "関数 $y = x^3$ の導関数は？", answer: "$$\\dfrac{dy}{dx} = 3x^2$$" },
      { title: "第2問（積分）", question: "$\\displaystyle \\int 2x\\,dx$ を求めよ。", answer: "$$x^2 + C$$" },
      { title: "第3問（三角）", question: "$\\sin 90^{\\circ}$ の値は？", answer: "$$1$$" },
      { title: "第4問（指数）", question: "$2^0$ の値は？", answer: "$$1$$" },
      { title: "第5問（対数）", question: "$\\log_{10} 100$ の値は？", answer: "$$2$$" },
      { title: "第6問（ベクトル）", question: "ベクトル $\\langle 1, 2 \\rangle$ と $\\langle 3, 4 \\rangle$ の内積は？", answer: "$$1 \\cdot 3 + 2 \\cdot 4 = 11$$" },
      { title: "第7問（一次方程式）", question: "一次方程式 $2x + 3 = 7$ の解は？", answer: "$$x = 2$$" },
      { title: "第8問（平方完成）", question: "$x^2 + 2x + 1$ を平方完成せよ。", answer: "$$(x + 1)^2$$" },
      { title: "第9問（確率）", question: "コイン1枚を1回投げるとき、表が出る確率は？", answer: "$$\\dfrac{1}{2}$$" },
      { title: "第10問（数列）", question: "等差数列 $a_1 = 1,\\ d = 2$ の第2項 $a_2$ を求めよ。", answer: "$$a_2 = 1 + 2 = 3$$" }
    ];

    const problemIndexEl = document.getElementById("problemIndex");
    const problemTotalEl = document.getElementById("problemTotal");
    const problemTitleEl = document.getElementById("problemTitle");
    const problemQuestionEl = document.getElementById("problemQuestion");
    const problemAnswerEl = document.getElementById("problemAnswer");
    const flashcardEl = document.getElementById("flashcard");

    let currentIndex = 0;
    let showingAnswer = false;

    function typesetCurrentCard() {
      // MathJax 読み込み後であれば、現在の問題・解答を再度タイプセット
      if (window.MathJax && MathJax.typesetPromise) {
        MathJax.typesetPromise([problemQuestionEl, problemAnswerEl]).catch(err => console.error(err.message));
      }
    }

    function renderProblem() {
      const p = problems[currentIndex];
      // タイトルは UI では非表示だが、念のため更新だけはしておく
      problemTitleEl.textContent = p.title;
      // LaTeX を含むので innerHTML を使う
      problemQuestionEl.innerHTML = p.question;
      problemAnswerEl.innerHTML = p.answer;
      problemIndexEl.textContent = String(currentIndex + 1);
      problemTotalEl.textContent = String(problems.length);
      problemAnswerEl.classList.add("is-hidden");
      showingAnswer = false;

      typesetCurrentCard();
    }

    // 簡単な自己テスト（既存テストは変更せずそのまま維持）
    function runSelfTests() {
      console.assert(Array.isArray(problems), "problems は配列である必要があります");
      console.assert(problems.length >= 1, "少なくとも 1 問は登録してください");
      console.assert(typeof problems[0].title === "string", "第1問に title が必要です");
      console.assert(typeof problems[0].question === "string", "第1問に question が必要です");
      console.assert(typeof problems[0].answer === "string", "第1問に answer が必要です");
      problems.forEach((p, i) => {
        console.assert(typeof p.title === "string" && p.title.length > 0, `問題${i + 1} に title が必要です`);
        console.assert(typeof p.question === "string" && p.question.length > 0, `問題${i + 1} に question が必要です`);
        console.assert(typeof p.answer === "string" && p.answer.length > 0, `問題${i + 1} に answer が必要です`);
      });
      // 追加の簡単テスト: EXP の初期値が数値か
      console.assert(typeof exp === "number", "exp は数値である必要があります");
    }

    // タップ（クリック）で「解答表示 → 次の問題」
    flashcardEl.addEventListener("click", () => {
      if (!showingAnswer) {
        // まだ解答を見ていない状態 → 解答を表示
        problemAnswerEl.classList.remove("is-hidden");
        showingAnswer = true;

        // 解答表示時に 1/5 の確率で EXP を 1 増やす
        if (Math.random() < 0.2) {
          exp += 1;
          saveExp();
          console.log("EXP +1:", exp);
        }

        typesetCurrentCard();
      } else {
        // 解答表示中 → 次の問題へ
        currentIndex = (currentIndex + 1) % problems.length;
        renderProblem();
      }
    });

    // 初期表示 & テスト実行
    loadExp();
    console.log("初期 EXP:", exp);
    runSelfTests();
    renderProblem();
  </script>
</body>
</html>
