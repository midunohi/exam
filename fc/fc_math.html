<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>数学 フラッシュカード</title>

  <style>
    :root{
      --bg:#0f172a; --panel:#0a0f1a; --card:#0b1220;
      --border:#1f2937; --fg:#e5e7eb; --muted:#9ca3af;
      --acc:#22d3ee; --answer:#7CFFB2;
    }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,
        "Hiragino Kaku Gothic ProN",Meiryo,sans-serif;
      line-height:1.7;
      background:
        linear-gradient(rgba(5,8,20,.75), rgba(5,8,20,.9)),
        url("../img/bg_fc_enExamples.png");
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      background-attachment:fixed;
      color:var(--fg);
    }
    .page{
      min-height:100vh;
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:80px 16px 24px;
      box-sizing:border-box;
    }
    .topbar{
      position:fixed;
      top:0; left:0; right:0;
      z-index:10;
      padding:8px 16px;
      display:flex;
      justify-content:center;
      background: linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,.4) 60%, transparent);
      backdrop-filter: blur(6px);
    }
    .topbar-inner{
      width:min(960px,96vw);
      display:flex;
      align-items:center;
      gap:14px;
      flex-wrap:wrap;
    }
    .topbar-inner .spacer{flex:1;}
    .app-title{
      font-size: clamp(18px,3.6vw,22px);
      font-weight: 800;
      letter-spacing: 0.02em;
    }
    .back-link{
      display:inline-flex;
      align-items:center;
      gap:6px;
      text-decoration:none;
      color: var(--fg);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.85rem;
      font-weight: 700;
      background: #0a1322;
    }
    .back-link:hover{ border-color:#2b3a55; }

    .flashcard{
      width: min(960px, 96vw);
      background: linear-gradient(180deg,#0a1322,#0a0f1a);
      border-radius: 0.9rem;
      padding: 1.2rem 1.4rem 1.8rem;
      border: 1px solid var(--border);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
      cursor: pointer;
      user-select: none;
      position:relative;
    }

    .category-row{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:6px;
    }
    .category-label{
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      color: var(--muted);
      text-transform: uppercase;
    }
    .category-name{
      font-size: clamp(16px,3.2vw,20px);
      font-weight: 800;
      letter-spacing: 0.01em;
      color: var(--fg);
      text-align: left;
    }
    .category-count{ font-size:0.85rem; color:var(--muted); }
    .progress{ font-size:0.85rem; color:var(--muted); }
    .category-spacer{ flex:1; }

    .card-title { display:none; }

    .qa{
      min-height: 120px;
      white-space: normal;
      font-size: clamp(18px,3.6vw,24px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .card-face{ width:100%; display:inline-block; }

    .card-answer{
      margin-top: 0.75rem;
      padding-top: 0.6rem;
      border-top: 1px dashed var(--border);
      color: var(--answer);
      transition: opacity 0.15s ease;
    }
    .card-answer.is-hidden{
      color: transparent;
      border-color: transparent;
    }

    .exp-corner{
      position:absolute;
      right:18px;
      bottom:16px;
      font-size:0.85rem;
      color:var(--muted);
    }

    @media (min-width: 768px) {
      .page { padding: 96px 16px 32px; }
    }
  </style>

  <!-- MathJax 設定 -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [["$", "$"], ["\\(", "\\)"]] },
      svg: { fontCache: "global" }
    };
  </script>
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="app-title">数学 フラッシュカード</div>
      <div class="spacer"></div>
      <a class="back-link" href="../index.html" aria-label="戻る">← 戻る</a>
    </div>
  </div>

  <div class="page">
    <section class="flashcard" id="flashcard">
      <div class="category-row" aria-label="カテゴリ">
        <div class="category-label">カテゴリ</div>
        <div id="categoryLabel" class="category-name">数学</div>
        <div id="totalCount" class="category-count">全0問</div>
        <div class="category-spacer"></div>
        <div id="countLabel" class="progress">0 / 0</div>
      </div>

      <div class="card-title" id="problemTitle">第1問</div>

      <div class="qa">
        <div class="card-face" id="problemQuestion"></div>
        <div class="card-face card-answer is-hidden" id="problemAnswer"></div>
      </div>

      <div class="exp-corner">EXP: <span id="expLabel">0</span></div>
    </section>
  </div>

  <script>
    // ---------- EXP ----------
    const EXP_KEY = "midunohi.exam.exp";
    let exp = 0;

    const expDisplayEl = document.getElementById("expLabel");
    const countLabelEl = document.getElementById("countLabel");
    const totalCountEl = document.getElementById("totalCount");

    function loadExp() {
      try {
        const stored = localStorage.getItem(EXP_KEY);
        if (stored == null) exp = 0;
        else {
          const n = Number(stored);
          exp = Number.isFinite(n) && n >= 0 ? Math.floor(n) : 0;
        }
      } catch (e) {
        console.warn("EXP を読み込めませんでした", e);
        exp = 0;
      }
      updateExpDisplay();
    }

    function saveExp() {
      try {
        localStorage.setItem(EXP_KEY, String(exp));
      } catch (e) {
        console.warn("EXP を保存できませんでした", e);
      }
      updateExpDisplay();
    }

    function updateExpDisplay() {
      if (expDisplayEl) expDisplayEl.textContent = String(exp);
    }

    // ---------- Problems ----------
const problems=[
["$(x^n)'は?$","$nx^{n-1}$"],
["$(\\sin x)'は?$","$\\cos x$"],
["$(\\cos x)'は?$","$-\\sin x$"],
["$(\\tan x)'は?$","$\\frac1{\\cos^2x}$"],
["$(e^x)'は?$","$e^x$"],
["$(a^x)'(a>0,a\\ne1)は?$","$a^x\\ln a$"],
["$(\\ln x)'は?$","$\\frac1x$"],
["$(\\log_a x)'は?$","$\\frac1{x\\ln a}$"],
["$(uv)'は?$","$u'v+uv'$"],
["$(f(g(x)))'は?$","$f'(g(x))g'(x)$"],

["$\\int x^n\\,dxは?$","$\\frac{x^{n+1}}{n+1}+C$"],
["$\\int \\frac1x\\,dxは?$","$\\ln|x|+C$"],
["$\\int e^x\\,dxは?$","$e^x+C$"],
["$\\int a^x\\,dxは?$","$\\frac{a^x}{\\ln a}+C$"],
["$\\int \\sin x\\,dxは?$","$-\\cos x+C$"],
["$\\int \\cos x\\,dxは?$","$\\sin x+C$"],
["$\\int \\frac1{\\cos^2x}\\,dxは?$","$\\tan x+C$"],
["$\\int \\frac1{1+x^2}\\,dxは?$","$\\arctan x+C$"],

["$\\lim_{x\\to0}\\frac{\\sin x}{x}は?$","$1$"],
["$\\lim_{n\\to\\infty}(1+\\frac1n)^nは?$","$e$"],
["$\\lim_{x\\to0}\\frac{e^x-1}{x}は?$","$1$"],
["$\\lim_{x\\to0}\\frac{\\ln(1+x)}xは?$","$1$"],
["$\\lim_{x\\to0}\\frac{1-\\cos x}{x^2}は?$","$\\frac12$"],

["$\\sin^2x+\\cos^2xは?$","$1$"],
["$1+\\tan^2xは?$","$\\frac1{\\cos^2x}$"],
["$\\sin(\\alpha+\\beta)は?$","$\\sin\\alpha\\cos\\beta+\\cos\\alpha\\sin\\beta$"],
["$\\cos(\\alpha+\\beta)は?$","$\\cos\\alpha\\cos\\beta-\\sin\\alpha\\sin\\beta$"],
["$\\sin2xは?$","$2\\sin x\\cos x$"],
["$\\cos2xは?$","$\\cos^2x-\\sin^2x$"],
["$\\tan2xは?$","$\\frac{2\\tan x}{1-\\tan^2x}$"],
["$\\sin\\frac\\pi6は?$","$\\frac12$"],
["$\\cos\\frac\\pi3は?$","$\\frac12$"],
["$\\tan\\frac\\pi4は?$","$1$"],
["$\\sin\\frac\\pi3は?$","$\\frac{\\sqrt3}2$"],
["$\\cos\\frac\\pi6は?$","$\\frac{\\sqrt3}2$"],
["$\\tan\\frac\\pi6は?$","$\\frac1{\\sqrt3}$"],

["$a^0(a\\ne0)は?$","$1$"],
["$a^{-n}は?$","$\\frac1{a^n}$"],
["$a^ma^nは?$","$a^{m+n}$"],
["$\\frac{a^m}{a^n}は?$","$a^{m-n}$"],
["$(a^m)^nは?$","$a^{mn}$"],
["$\\log_a(bc)は?$","$\\log_ab+\\log_ac$"],
["$\\log_a\\frac bcは?$","$\\log_ab-\\log_ac$"],
["$\\log_a(b^c)は?$","$c\\log_ab$"],
["$\\log_a1は?$","$0$"],
["$\\log_aaは?$","$1$"],
["$\\log_abは?$","$\\frac{\\ln b}{\\ln a}$"],

["$(a+b)^2は?$","$a^2+2ab+b^2$"],
["$(a-b)^2は?$","$a^2-2ab+b^2$"],
["$a^2-b^2は?$","$(a-b)(a+b)$"],
["$(a+b)^3は?$","$a^3+3a^2b+3ab^2+b^3$"],
["$a^3-b^3は?$","$(a-b)(a^2+ab+b^2)$"],
["$a^3+b^3は?$","$(a+b)(a^2-ab+b^2)$"],
["$(x+a)(x+b)は?$","$x^2+(a+b)x+ab$"],
["$x^2+2px+p^2は?$","$(x+p)^2$"],
["$x^2-(a+b)x+abは?$","$(x-a)(x-b)$"],
["$ax^2+bx+c=0は?$","$x=\\frac{-b\\pm\\sqrt{b^2-4ac}}{2a}$"],
["$\\Deltaは?$","$b^2-4ac$"],
["$x_1+x_2は?$","$-\\frac ba$"],
["$x_1x_2は?$","$\\frac ca$"],
["$y=ax^2+bx+c\\ \\text{軸}は?$","$x=-\\frac b{2a}$"],
["$ax^2+bx+c\\ \\text{平方完成}は?$","$a(x+\\frac b{2a})^2-\\frac{b^2-4ac}{4a}$"],

["$\\text{等差 }a_nは?$","$a_1+(n-1)d$"],
["$\\text{等差 }S_nは?$","$\\frac n2(a_1+a_n)$"],
["$\\text{等比 }a_nは?$","$a_1r^{n-1}$"],
["$\\text{等比 }S_n(r\\ne1)は?$","$a_1\\frac{1-r^n}{1-r}$"],
["$\\sum_{k=1}^n kは?$","$\\frac{n(n+1)}2$"],
["$\\sum_{k=1}^n k^2は?$","$\\frac{n(n+1)(2n+1)}6$"],
["$\\sum_{k=1}^n k^3は?$","$\\left(\\frac{n(n+1)}2\\right)^2$"],
["$\\sum_{k=0}^{\\infty}ar^k(|r|<1)は?$","$\\frac a{1-r}$"],

["$n!は?$","$1\\cdot2\\cdots n$"],
["${}_nP_rは?$","$\\frac{n!}{(n-r)!}$"],
["${}_nC_rは?$","$\\frac{n!}{r!(n-r)!}$"],
["${}_nH_rは?$","${}_{n+r-1}C_r$"],

["$P(A\\cup B)は?$","$P(A)+P(B)-P(A\\cap B)$"],
["$P(A\\mid B)は?$","$\\frac{P(A\\cap B)}{P(B)}$"],
["$A\\perp B\\ (\\text{独立})は?$","$P(A\\cap B)=P(A)P(B)$"],
["$X\\sim\\text{Bin}(n,p),\\ P(X=k)は?$","${}_nC_kp^k(1-p)^{n-k}$"],
["$X\\sim\\text{Bin}(n,p),\\ E[X]は?$","$np$"],
["$X\\sim\\text{Bin}(n,p),\\ V[X]は?$","$np(1-p)$"],

["$\\langle a,b\\rangle\\cdot\\langle c,d\\rangleは?$","$ac+bd$"],
["$\\vec a\\cdot\\vec bは?$","$|a||b|\\cos\\theta$"],
["$|\\langle a,b\\rangle|は?$","$\\sqrt{a^2+b^2}$"],
["$\\langle a,b\\rangle\\times\\langle c,d\\rangleは?$","$ad-bc$"],
["$\\begin{vmatrix}a&b\\\\c&d\\end{vmatrix}は?$","$ad-bc$"],

["$A(x_1,y_1),B(x_2,y_2)\\ \\text{距離}は?$","$\\sqrt{(x_2-x_1)^2+(y_2-y_1)^2}$"],
["$A(x_1,y_1),B(x_2,y_2)\\ \\text{中点}は?$","$(\\frac{x_1+x_2}2,\\frac{y_1+y_2}2)$"],
["$A(x_1,y_1),B(x_2,y_2)\\ \\text{傾き}は?$","$\\frac{y_2-y_1}{x_2-x_1}$"],
["$\\text{点}(x_1,y_1),\\text{傾き}m\\ \\text{直線}は?$","$y-y_1=m(x-x_1)$"],
["$(x-a)^2+(y-b)^2=r^2\\ \\text{中心}は?$","$(a,b)$"],

["$i^2は?$","$-1$"],
["$(a+bi)(c+di)は?$","$(ac-bd)+(ad+bc)i$"],
["$|a+bi|は?$","$\\sqrt{a^2+b^2}$"],
["$(\\cos\\theta+i\\sin\\theta)^nは?$","$\\cos n\\theta+i\\sin n\\theta$"],

["$\\int xe^x\\,dxは?$","$e^x(x-1)+C$"],
["$\\triangle\\ \\text{面積}(a,b,C)は?$","$\\frac12ab\\sin C$"],
["$\\text{正弦定理}は?$","$\\frac a{\\sin A}=\\frac b{\\sin B}=\\frac c{\\sin C}=2R$"],
["$\\text{余弦定理}は?$","$a^2=b^2+c^2-2bc\\cos A$"]
];


    const problemTitleEl = document.getElementById("problemTitle");
    const problemQuestionEl = document.getElementById("problemQuestion");
    const problemAnswerEl = document.getElementById("problemAnswer");
    const flashcardEl = document.getElementById("flashcard");

    let currentIndex = 0;
    let showingAnswer = false;
    let cycleCount = 0;
    let busy = false;
    let lastIndex = -1;

    function pickRandomIndex() {
      if (problems.length <= 1) return 0;
      let i = Math.floor(Math.random() * problems.length);
      while (i === lastIndex) {
        i = Math.floor(Math.random() * problems.length);
      }
      return i;
    }

    // ---------- MathJax helpers ----------
    function delay(ms){ return new Promise(r => setTimeout(r, ms)); }

    async function waitForMathJax(maxMs = 5000) {
      const t0 = performance.now();
      while (performance.now() - t0 < maxMs) {
        const mj = window.MathJax;
        if (mj && mj.typesetPromise && mj.startup && mj.startup.promise) {
          await mj.startup.promise; // 完全起動待ち
          return mj;
        }
        await delay(25);
      }
      return null; // MathJax来ない場合も落ちないようにする
    }

    async function typesetElements(els) {
      const mj = await waitForMathJax();
      if (!mj) return; // MathJax未到着なら素表示で進む
      if (mj.typesetClear) mj.typesetClear(els);
      await mj.typesetPromise(els);
    }

    // ---------- Render ----------
    function normalizeProblem(p, index) {
      if (Array.isArray(p)) {
        return {
          title: `第${index + 1}問`,
          question: String(p[0] ?? ""),
          answer: String(p[1] ?? "")
        };
      }
      if (p && typeof p === "object") {
        const question = p.question ?? p.q ?? "";
        const answer = p.answer ?? p.a ?? "";
        const title = p.title ?? `第${index + 1}問`;
        return {
          title: String(title),
          question: String(question),
          answer: String(answer)
        };
      }
      return { title: `第${index + 1}問`, question: "", answer: "" };
    }

    async function renderProblem() {
      const p = normalizeProblem(problems[currentIndex], currentIndex);

      // まず普通に表示（MathJax待ちの間も文字が出る）
      problemTitleEl.textContent = p.title;
      problemQuestionEl.innerHTML = p.question;
      problemAnswerEl.innerHTML = p.answer;

      problemAnswerEl.classList.add("is-hidden");
      showingAnswer = false;

      if (totalCountEl) totalCountEl.textContent = `全${problems.length}問`;
      if (countLabelEl) countLabelEl.textContent = `${cycleCount} / 10`;

      // その後にMathJaxで整える（準備できた時点で反映）
      await typesetElements([problemQuestionEl, problemAnswerEl]);
    }

    // ---------- Self test ----------
    function runSelfTests() {
      console.assert(Array.isArray(problems), "problems は配列である必要があります");
      console.assert(problems.length >= 1, "少なくとも 1 問は登録してください");
      problems.forEach((p, i) => {
        const n = normalizeProblem(p, i);
        console.assert(typeof n.title === "string" && n.title.length > 0, `問題${i + 1} に title が必要です`);
        console.assert(typeof n.question === "string" && n.question.length > 0, `問題${i + 1} に question が必要です`);
        console.assert(typeof n.answer === "string" && n.answer.length > 0, `問題${i + 1} に answer が必要です`);
      });
      console.assert(typeof exp === "number", "exp は数値である必要があります");
    }

    // ---------- Click behavior ----------
    flashcardEl.addEventListener("click", async () => {
      if (busy) return;
      busy = true;
      try {
        if (!showingAnswer) {
          problemAnswerEl.classList.remove("is-hidden");
          showingAnswer = true;
          await typesetElements([problemAnswerEl]);
        } else {
          exp += 1;
          saveExp();

          cycleCount = Math.min(cycleCount + 1, 10);
          if (countLabelEl) countLabelEl.textContent = `${cycleCount} / 10`;

          lastIndex = currentIndex;
          currentIndex = pickRandomIndex();
          if (cycleCount === 10) cycleCount = 0;

          await renderProblem();
        }
      } finally {
        busy = false;
      }
    });

    // ---------- Boot ----------
    (async () => {
      loadExp();
      runSelfTests();
      currentIndex = pickRandomIndex();
      await renderProblem();
    })();
  </script>
</body>
</html>
