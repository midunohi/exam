<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>英単語・例文 フラッシュカード</title>
  <style>
    :root{ --bg:#0f172a; --panel:#0a0f1a; --card:#0b1220; --border:#1f2937; --fg:#e5e7eb; --muted:#9ca3af; --acc:#22d3ee; --answer:#7CFFB2; }
    html, body{ height:100%; margin:0; background: linear-gradient( rgba(5, 8, 20, 0.75), rgba(5, 8, 20, 0.9)), url("../img/bg_fc_enExamples.png"); background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: fixed; font-family: system-ui,-apple-system,Segoe UI,Roboto, "Hiragino Kaku Gothic ProN",Meiryo,sans-serif; color:var(--fg); }
    .page{
      min-height:100vh;
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:80px 16px 24px;
      box-sizing:border-box;
    }
    .topbar{
      position:fixed;
      top:0;
      left:0;
      right:0;
      z-index:10;
      padding:8px 16px;
      display:flex;
      justify-content:center;
      background: linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,.4) 60%, transparent);
      backdrop-filter: blur(6px);
    }
    .topbar-inner{
      width:min(960px,96vw);
      display:flex;
      align-items:center;
      gap:14px;
      flex-wrap:wrap;
    }
    .topbar-inner .spacer{flex:1;}
    .title{font-weight:800; letter-spacing:.3px; white-space:normal; word-break:break-word; line-height:1.15; font-size:clamp(18px,3.6vw,22px)}
    .meta{margin-top:8px; color:var(--muted); font-size:13px}
    .category-row{display:flex; align-items:center; gap:10px;}
    .category-label{font-size:0.75rem; font-weight:700; letter-spacing:0.08em; color:var(--muted); text-transform:uppercase;}
    .category-name{font-size:clamp(16px,3.2vw,20px); font-weight:800; letter-spacing:0.01em; color:var(--fg); text-align:left;}
    .category-count{font-size:0.85rem; color:var(--muted);}
    .progress{font-size:0.85rem; color:var(--muted);}
    .category-spacer{flex:1;}
    button{background:#0a1322; color:var(--fg); border:1px solid var(--border); border-radius:12px; padding:10px 14px; font-weight:800; cursor:pointer}
    button:hover{border-color:#2b3a55}

    .card{width:min(960px,96vw); background:linear-gradient(180deg,#0a1322,#0a0f1a); border:1px solid var(--border); border-radius:20px; padding:24px; display:grid; grid-template-columns:1fr; gap:16px; align-items:start; box-shadow:0 10px 30px rgba(0,0,0,.35); position:relative;}
    .term-mean{display:flex; align-items:baseline; gap:12px; flex-wrap:wrap}
    .term{line-height:1.2;}
    .phrases{display:flex; flex-direction:column; gap:8px}
    .phrase-line{display:flex; flex-direction:column; gap:2px; align-items:flex-start}
    .phrase-ja{line-height:1.4; min-height:1.4em}
    .q-text,.a-text{font-size:clamp(18px,3.6vw,24px); font-weight:700;}
    .question{color:var(--muted);}
    .question.is-active{color:var(--fg);}
    .answer{color:var(--answer);}
    .answer.is-hidden{visibility:hidden;}

    a.back{color:var(--fg); text-decoration:none; font-size:14px; border:1px solid var(--border); border-radius:999px; padding:6px 12px; font-weight:700; background:#0a1322;}
    a.back:hover{border-color:#2b3a55}
    .exp-badge{position:absolute; right:18px; bottom:16px; font-size:12px; color:var(--muted);}

    @media (max-width: 640px){
      .container{padding:12px 12px 56px;}
      .card{padding:18px; border-radius:16px}
      button{padding:10px 12px}
    }
  </style>

  <!-- files.js を「普通の script」として先に読み込む（export無しでも使えるように） -->
  <script src="../en_examples/files.js"></script>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="title">英単語・例文 フラッシュカード</div>
      <div class="spacer"></div>
      <a class="back" href="../index.html">← 戻る</a>
    </div>
  </div>

  <div class="page">
    <section class="card" aria-live="polite" id="card" tabindex="0">
      <div class="category-row" aria-label="カテゴリと切り替え">
        <div class="category-label">カテゴリ</div>
        <div id="categoryLabel" class="category-name">--</div>
        <div id="totalCount" class="category-count">全0問</div>
        <div class="category-spacer"></div>
        <button id="randomBtn" type="button">切り替え</button>
      </div>
      <div id="countLabel" class="progress">0 / 10</div>
      <div class="term-mean">
        <div class="term question q-text" id="term">...</div>
        <div class="mean answer a-text is-hidden" id="meaning"></div>
      </div>
      <div class="phrases" id="phrases"></div>
      <div class="exp-badge" id="expLabel">EXP: 0</div>
    </section>
  </div>

  <script>
  // ============================
  // Loader: en_examples/* を読み込んで dataset[] に変換
  // 期待する各ファイルの形式（例）：
  //   [
  //     [["planet","惑星"],["a rocky planet","岩石惑星"],["...","..."],["...","..."]],
  //     ...
  //   ]
  // files.js：
  //   const files_enExamples = ["astronomy", ...]
  // ============================

  const STUB_EN_EXAMPLES = [
    [
      ["planet", "惑星"],
      ["a rocky planet", "岩石惑星"],
      ["clear its orbital neighborhood", "軌道近傍を一掃する"],
      ["in the habitable zone", "ハビタブルゾーン内で"],
    ],
  ];

  const EXP_KEY = "midunohi.exam.exp";

  function loadExp(){
    try{
      const raw = localStorage.getItem(EXP_KEY);
      const n = Number(raw || 0);
      return Number.isFinite(n) && n >= 0 ? Math.floor(n) : 0;
    }catch(_){
      return 0;
    }
  }

  function saveExp(){
    try{ localStorage.setItem(EXP_KEY, String(exp)); }catch(_){ /* noop */ }
  }

  let exp = loadExp();
  let currentCategory = '--';
  let cycleCount = 0;
  let answeredCount = 0;
  let currentFileIndex = -1;

  function safeGlobalEval(name){
    // グローバルレキシカル環境（const）から取り出すための global eval
    try{ return (0, eval)(name); }catch(_){ return undefined; }
  }

  function ensureMinPhrases(phrases, n=3){
    const out = Array.isArray(phrases) ? phrases.slice(0) : [];
    while(out.length < n) out.push({en:"", ja:""});
    return out;
  }

  function toDataset(enExamplesRaw){
    if(!enExamplesRaw) return [];

    if(Array.isArray(enExamplesRaw)){
      const items = enExamplesRaw.map((row)=>{
        if(!Array.isArray(row) || row.length === 0) return null;
        const pairs = row.filter(p => Array.isArray(p) && p.length >= 1);
        const head = pairs[0] || [];
        const en = String(head[0] ?? "");
        const ja = String(head[1] ?? "");
        const phrases = ensureMinPhrases(
          pairs.slice(1).map(p => ({ en: String(p?.[0] ?? ""), ja: String(p?.[1] ?? "") }))
        );
        return { en, ja, phrases };
      }).filter(Boolean);
      return items.filter(x => x.en && (x.ja || x.phrases.some(p=>p.en||p.ja)));
    }

    if(typeof enExamplesRaw === 'object'){
      const entries = Object.entries(enExamplesRaw);
      const items = entries.map(([en, v])=>{
        const ja = v?.ja ?? "";
        const examples = v?.examples ?? v?.phrases ?? v?.ex ?? [];
        const phrases = ensureMinPhrases(
          examples.map(p => ({ en: String(p?.en ?? ""), ja: String(p?.ja ?? "") }))
        );
        return { en, ja, phrases };
      });
      return items.filter(x => x.en && (x.ja || x.phrases.some(p=>p.en||p.ja)));
    }

    return [];
  }

  async function fetchJson(src){
    const res = await fetch(src, { cache: 'no-cache' });
    if(!res.ok) throw new Error(`fetch failed: ${src} (${res.status})`);
    return await res.json();
  }

  function normalizeBaseName(name){
    const base = name.replace(/\.(json|js)$/,'');
    if(base === 'quantity_degrees') return 'quantity_degree';
    return base;
  }

  async function loadEnExamplesFile(name){
    const base = normalizeBaseName(name);
    const jsonSrc = `../en_examples/${base}.json`;
    const jsSrc = `../en_examples/${base}.js`;

    try{
      const obj = await fetchJson(jsonSrc);
      return { ok:true, name:base, obj };
    }catch(err){
      try{
        await new Promise((resolve, reject)=>{
          const s = document.createElement('script');
          s.src = jsSrc;
          s.async = true;
          s.onload = ()=>resolve(true);
          s.onerror = ()=>reject(new Error('load failed: '+jsSrc));
          document.head.appendChild(s);
        });
        const globalName = `enExamples_${base}`;
        const obj = safeGlobalEval(globalName);
        if(!obj) throw new Error(`global not found: ${globalName}`);
        return { ok:true, name:base, obj };
      }catch(err2){
        console.warn(err2);
        return { ok:false, name:base, obj:STUB_EN_EXAMPLES, err:err2 };
      }
    }
  }

  function getFiles(){
    const files = (typeof files_enExamples !== 'undefined' && Array.isArray(files_enExamples))
      ? files_enExamples
      : ["astronomy"];
    return files.length ? files : ["astronomy"];
  }

  function pickRandomIndex(len, except){
    if(len <= 1) return 0;
    let n = 0;
    do{ n = Math.floor(Math.random() * len); }while(n === except);
    return n;
  }

  function getRevealTotal(item){
    let total = 0;
    if(item.ja) total += 1;
    (item.phrases || []).forEach(p=>{ if(p.ja) total += 1; });
    return total;
  }

  // ============================
  // Flashcards Core
  // ============================

  let dataset = []; // 動的にセット
  let idx = 0;
  let revealStep = 0;

  // --- Elements --------------------------------------------------------
  const els = {
    term: document.getElementById('term'),
    meaning: document.getElementById('meaning'),
    phrases: document.getElementById('phrases'),
    card: document.getElementById('card'),
    categoryLabel: document.getElementById('categoryLabel'),
    countLabel: document.getElementById('countLabel'),
    totalCount: document.getElementById('totalCount'),
    expLabel: document.getElementById('expLabel'),
    randomBtn: document.getElementById('randomBtn')
  };

  // --- Rendering -------------------------------------------------------
  function updateMeta(){
    els.categoryLabel.textContent = `${currentCategory}`;
    els.expLabel.textContent = `EXP: ${exp}`;
    if(els.totalCount) els.totalCount.textContent = `全${dataset.length}問`;
    if(els.countLabel) els.countLabel.textContent = `${cycleCount} / 10`;
  }

  function render(){
    if(!dataset.length){
      els.term.textContent = '…';
      els.meaning.textContent = '';
      els.meaning.classList.add('is-hidden');
      els.phrases.innerHTML = '';
      updateMeta();
      return;
    }

    const item = dataset[idx];
    els.term.textContent = item.en;
    els.meaning.textContent = item.ja || '';

    const meaningVisible = item.ja && revealStep >= 1;
    els.meaning.classList.toggle('is-hidden', !meaningVisible);

    els.phrases.innerHTML = '';

    let step = item.ja ? 1 : 0;
    const questionEls = [];
    questionEls.push(els.term);
    (item.phrases || []).forEach((p, i) => {
      const line = document.createElement('div');
      line.className = 'phrase-line';
      const en = document.createElement('div');
      en.className = 'phrase-en question q-text';
      en.textContent = p.en;
      const ja = document.createElement('div');
      ja.className = 'phrase-ja answer a-text';
      ja.textContent = p.ja;
      let jaVisible = false;
      if(p.ja){
        step += 1;
        jaVisible = revealStep >= step;
      }
      ja.classList.toggle('is-hidden', !jaVisible);
      line.appendChild(en);
      line.appendChild(ja);
      els.phrases.appendChild(line);
      questionEls.push(en);
    });

    const total = getRevealTotal(item);
    if(total === 0 || revealStep >= total){
      questionEls.forEach(el => el.classList.add('is-active'));
    }else{
      questionEls.forEach(el => el.classList.remove('is-active'));
      const activeIndex = Math.min(revealStep, questionEls.length - 1);
      questionEls[activeIndex].classList.add('is-active');
    }
    updateMeta();
  }

  // --- Actions ---------------------------------------------------------
  function gainExp(n){
    exp += n;
    saveExp();
    updateMeta();
  }

  function nextCard(){
    idx = pickRandomIndex(dataset.length, idx);
    revealStep = 0;
    cycleCount = Math.min(cycleCount + 1, 10);
    render();
  }

  function advance(){
    if(!dataset.length) return;
    const item = dataset[idx];
    const total = getRevealTotal(item);

    if(total === 0){
      gainExp(1);
      nextCard();
      return;
    }

    if(revealStep < total){
      revealStep += 1;
      render();
      return;
    }

    gainExp(1);
    answeredCount += 1;
    if(answeredCount % 10 === 0){
      loadRandomCategory(currentFileIndex);
      return;
    }
    nextCard();
  }

  // --- Events ----------------------------------------------------------
  els.card.addEventListener('click', advance);

  window.addEventListener('keydown', e=>{
    if(['Space','Enter'].includes(e.code)) e.preventDefault();
    if(e.code==='Space' || e.code==='Enter') advance();
  }, {passive:false});

  // ============================
  // Boot
  // ============================

  async function loadRandomCategory(exceptIndex = -1){
    const files = getFiles();
    const idxFile = pickRandomIndex(files.length, exceptIndex);
    const filename = files[idxFile];
    currentCategory = filename.replace(/\.(json|js)$/,'');

    els.term.textContent = 'loading…';
    els.meaning.textContent = '';
    els.meaning.classList.add('is-hidden');
    els.phrases.innerHTML = '';

    const res = await loadEnExamplesFile(filename);
    dataset = toDataset(res.obj);
    if(!dataset.length){
      dataset = toDataset(STUB_EN_EXAMPLES);
    }

    idx = pickRandomIndex(dataset.length, -1);
    revealStep = 0;
    cycleCount = 1;
    answeredCount = 0;
    currentFileIndex = idxFile;
    render();
  }

  function boot(){
    els.randomBtn.addEventListener('click', ()=>loadRandomCategory(currentFileIndex));
    loadRandomCategory(-1);
  }

  boot();
  </script>
</body>
</html>
