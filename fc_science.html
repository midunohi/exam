<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flashcards: Science Vocabulary</title>
  <style>
    :root{ --bg:#0f172a; --panel:#0a0f1a; --card:#0b1220; --border:#1f2937; --fg:#e5e7eb; --muted:#9ca3af; --acc:#22d3ee; --good:#34d399; }
    html,body{height:100%; margin:0; background: radial-gradient(70rem 60rem at 50% -10%, #0b1220 0%, var(--bg) 40%, #070b14 100%); font-family: system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;}
    .container{max-width:960px; margin:0 auto; padding:16px 16px 72px;}
    header{display:flex; gap:12px; align-items:center; justify-content:space-between; color:var(--fg); margin-top:12px}
    header .title{font-weight:800; letter-spacing:.3px; white-space:normal; word-break:break-word; line-height:1.25}
    .card{margin-top:14px; background:linear-gradient(180deg,#0a1322,#0a0f1a); border:1px solid var(--border); border-radius:20px; padding:24px; display:grid; grid-template-columns:1fr; gap:16px; align-items:start; box-shadow:0 10px 30px rgba(0,0,0,.35);}
    .term-mean{display:flex; align-items:baseline; gap:12px; flex-wrap:wrap}
    .term{font-size:36px; line-height:1.2; color:var(--fg); font-weight:800;}
    .mean{font-size:24px; color:var(--acc);}
    .phrases{display:flex; flex-direction:column; gap:8px}
    .phrase-line{display:flex; flex-direction:column; gap:2px; align-items:flex-start}
    .phrase-en{color:var(--fg); font-size:16px}
    /* 日本語は非表示時でも1行分の高さを保持 */
    .phrase-ja{color:var(--muted); font-size:16px; line-height:1.4; min-height:1.4em}
    .foot{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:10px; color:var(--muted); flex-wrap:wrap}
    .meters{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .meter{display:flex; align-items:center; gap:8px}
    .bar{position:relative; width:220px; height:10px; background:#0c1220; border:1px solid var(--border); border-radius:999px; overflow:hidden}
    .fill{position:absolute; inset:0; width:0%; background:linear-gradient(90deg, var(--acc), var(--good)); box-shadow:0 0 20px rgba(34,211,238,.4) inset}
    .count{font-weight:700; color:var(--fg)}
    .hint{font-size:12px; color:var(--muted)}
    a.back{color:var(--acc); text-decoration:none; font-size:14px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">Science Flashcards<br/>サイエンス語彙フラッシュカード</div>
    </header>

    <section class="card" aria-live="polite" id="card" tabindex="0">
      <div class="term-mean">
        <div class="term" id="term">...</div>
        <div class="mean" id="meaning"></div>
      </div>
      <div class="phrases" id="phrases"></div>
      <div class="foot">
        <div class="meters" aria-live="polite">
          <div class="meter" title="この周回の進捗">
            <span class="badge">Cycle</span>
            <div class="bar" aria-label="Reveal Cycle Progress" role="progressbar" aria-valuemin="0" aria-valuemax="10" aria-valuenow="0">
              <div class="fill" id="cycleFill"></div>
            </div>
            <span class="badge" id="cycleText">0 / 10</span>
          </div>
          <div class="meter" title="トータルの表示回数">
            <span class="badge">Reveals</span>
            <span class="count" id="revealCount">0</span>
          </div>
        </div>
        <div id="progress">0 / 0</div>
        <div class="hint">タップ/クリックで答えを表示 → もう一度で次へ（Space/Enter/→も可）</div>
      </div>
    </section>
  </div>
  <div style="padding:16px; max-width:960px; margin:0 auto"><a class="back" href="index.html">戻る</a></div>

  <script>
  // --- Data ------------------------------------------------------------
  const dataset = [
    { en:'atom', ja:'原子', phrases:[
      {en:'An atom is the smallest unit of matter.', ja:'原子は物質の最小単位です。'},
      {en:'Electrons orbit the nucleus of an atom.', ja:'電子は原子核の周りを回っている。'},
      {en:'Gold atoms form a metallic lattice.', ja:'金の原子は金属格子を作る。'}
    ] },
    { en:'molecule', ja:'分子', phrases:[
      {en:'Water is made up of molecules.', ja:'水は分子からできている。'},
      {en:'A molecule consists of two or more atoms bonded together.', ja:'分子は二つ以上の原子が結合してできる。'},
      {en:'Oxygen molecules have two oxygen atoms.', ja:'酸素分子は酸素原子が二つからなる。'}
    ] },
    { en:'gravity', ja:'重力', phrases:[
      {en:'Gravity pulls objects toward Earth.', ja:'重力は物体を地球に引き寄せる。'},
      {en:'Astronauts feel weightless because gravity is weaker in orbit.', ja:'宇宙飛行士は軌道上で重力が弱いため無重力のように感じる。'},
      {en:'Gravity depends on mass and distance.', ja:'重力は質量と距離に依存する。'}
    ] },
    { en:'energy', ja:'エネルギー', phrases:[
      {en:'Solar panels convert sunlight into energy.', ja:'ソーラーパネルは太陽光をエネルギーに変換する。'},
      {en:'Energy cannot be created or destroyed.', ja:'エネルギーは生成も消滅もしない。'},
      {en:'Kinetic energy increases with speed.', ja:'運動エネルギーは速度とともに増加する。'}
    ] },
    { en:'experiment', ja:'実験', phrases:[
      {en:'The students conducted an experiment.', ja:'学生たちは実験を行った。'},
      {en:'Repeat the experiment to verify the results.', ja:'結果を検証するために実験を繰り返す。'},
      {en:'We used a control group in the experiment.', ja:'実験では対照群を用いた。'}
    ] },
    { en:'hypothesis', ja:'仮説', phrases:[
      {en:'The scientist proposed a new hypothesis.', ja:'科学者は新しい仮説を提案した。'},
      {en:'A good hypothesis is testable.', ja:'良い仮説は検証可能である。'},
      {en:'We designed an experiment to test the hypothesis.', ja:'仮説を検証するために実験を設計した。'}
    ] },
    { en:'reaction', ja:'反応', phrases:[
      {en:'The chemical reaction produced heat.', ja:'化学反応で熱が発生した。'},
      {en:'A catalyst speeds up the reaction.', ja:'触媒は反応を速める。'},
      {en:'We observed a color change during the reaction.', ja:'反応中に色の変化を観察した。'}
    ] },
    { en:'observation', ja:'観察', phrases:[
      {en:'Careful observation is important.', ja:'注意深い観察が重要です。'},
      {en:'Record your observations in a notebook.', ja:'観察結果をノートに記録しなさい。'},
      {en:'Observation helps us find patterns.', ja:'観察はパターンの発見に役立つ。'}
    ] },
    { en:'theory', ja:'理論', phrases:[
      {en:'The theory of evolution explains change.', ja:'進化論は変化を説明する。'},
      {en:'A theory is supported by evidence.', ja:'理論は証拠によって支えられる。'},
      {en:'The new data challenges the current theory.', ja:'新しいデータは現在の理論に疑問を投げかける。'}
    ] },
    { en:'variable', ja:'変数', phrases:[
      {en:'Temperature was the independent variable.', ja:'温度が独立変数であった。'},
      {en:'We controlled the other variables.', ja:'他の変数は制御した。'},
      {en:'The dependent variable is what you measure.', ja:'従属変数は測定する対象である。'}
    ] }
  ];

  // --- State -----------------------------------------------------------
  let idx = 0;
  let revealed = false;
  let revealTotal = Number(localStorage.getItem('revealTotal')||0);
  let cycleReveals = Number(sessionStorage.getItem('cycleReveals')||0);
  const cycleGoal = dataset.length; // 一周分の目標

  // --- Elements --------------------------------------------------------
  const els = {
    term: document.getElementById('term'),
    meaning: document.getElementById('meaning'),
    phrases: document.getElementById('phrases'),
    progress: document.getElementById('progress'),
    cycleFill: document.getElementById('cycleFill'),
    cycleText: document.getElementById('cycleText'),
    revealCount: document.getElementById('revealCount'),
    card: document.getElementById('card')
  };

  // --- Rendering -------------------------------------------------------
  function render(){
    const item = dataset[idx];
    els.term.textContent = item.en;
    els.meaning.textContent = revealed ? item.ja : '';
    els.phrases.innerHTML = '';
    item.phrases.forEach(p => {
      const line = document.createElement('div');
      line.className = 'phrase-line';
      const en = document.createElement('div');
      en.className = 'phrase-en';
      en.textContent = p.en;
      const ja = document.createElement('div');
      ja.className = 'phrase-ja';
      ja.textContent = p.ja;
      ja.style.visibility = revealed ? 'visible' : 'hidden';
      line.appendChild(en);
      line.appendChild(ja);
      els.phrases.appendChild(line);
    });
    els.progress.textContent = `${idx+1} / ${dataset.length}`;

    // meters
    const pct = Math.min(100, (cycleReveals / cycleGoal) * 100);
    els.cycleFill.style.width = pct + '%';
    els.revealCount.textContent = String(revealTotal);
    const bar = els.cycleFill.parentElement;
    bar.setAttribute('aria-valuemax', String(cycleGoal));
    bar.setAttribute('aria-valuenow', String(cycleReveals));
    els.cycleText.textContent = `${cycleReveals} / ${cycleGoal}`;
  }

  // --- Actions ---------------------------------------------------------
  function doReveal(){
    if(!revealed){
      revealed = true;
      revealTotal += 1;
      cycleReveals += 1;
      localStorage.setItem('revealTotal', String(revealTotal));
      sessionStorage.setItem('cycleReveals', String(cycleReveals));
      try{ if('vibrate' in navigator) navigator.vibrate(10); }catch(_){/* noop */}
      // 周回達成で軽い演出
      if(cycleReveals >= cycleGoal){
        pulseBar();
        cycleReveals = 0; // 周回をリセット
        sessionStorage.setItem('cycleReveals', '0');
      }
      render();
    } else {
      // 既に表示中→Hide
      revealed = false; render();
    }
  }

  function next(){
    if(!revealed){ doReveal(); }
    else { revealed=false; idx=(idx+1)%dataset.length; render(); }
  }
  function prev(){
    if(revealed){ revealed=false; render(); }
    else { idx=(idx-1+dataset.length)%dataset.length; render(); }
  }

  function pulseBar(){
    const el = els.cycleFill;
    el.animate([
      {filter:'brightness(1)'},
      {filter:'brightness(2)'},
      {filter:'brightness(1)'}
    ], {duration:600, easing:'ease-in-out'});
  }

  // --- Events ----------------------------------------------------------
  // タップ/クリックでReveal→次へ（従来動作を維持）
  els.card.addEventListener('click', next);

  // キーボード操作
  window.addEventListener('keydown', e=>{
    if(['Space','Enter','ArrowRight','ArrowLeft'].includes(e.code)) e.preventDefault();
    if(e.code==='Space' || e.code==='Enter') doReveal();
    else if(e.code==='ArrowRight') next();
    else if(e.code==='ArrowLeft') prev();
  }, {passive:false});

  // --- Simple Tests (console) -----------------------------------------
  ;(function runTests(){
    const results = [];
    const assert = (name, cond)=>{ results.push({name, pass: !!cond}); console[cond? 'log':'error']((cond?'✅':'❌')+" "+name); };

    // Test 1: JA line exists & hidden when not revealed, but height reserved
    const firstJa = document.querySelector('.phrase-ja');
    assert('JA exists after initial render', !!firstJa);
    assert('JA hidden when not revealed', firstJa && firstJa.style.visibility === 'hidden');
    assert('JA reserves height (offsetHeight > 0)', firstJa && firstJa.offsetHeight > 0);

    // Test 2: doReveal toggles to visible and increments counters
    const prevTotal = Number(localStorage.getItem('revealTotal')||0);
    const prevCycle = Number(sessionStorage.getItem('cycleReveals')||0);
    doReveal();
    const firstJaAfter = document.querySelector('.phrase-ja');
    assert('JA visible after reveal', firstJaAfter && firstJaAfter.style.visibility === 'visible');
    assert('revealTotal increments', Number(localStorage.getItem('revealTotal')||0) === prevTotal + 1);
    const cyc = Number(sessionStorage.getItem('cycleReveals')||0);
    assert('cycleReveals increments or resets at goal', cyc === prevCycle + 1 || (prevCycle + 1 === cycleGoal && cyc === 0));

    // Test 3: Cycle reset behavior
    revealed = false; render();
    cycleReveals = cycleGoal - 1; sessionStorage.setItem('cycleReveals', String(cycleReveals)); render();
    doReveal(); // should reset
    assert('cycle resets to 0 at goal', Number(sessionStorage.getItem('cycleReveals')||0) === 0);

    // Clean up view
    revealed = false; render();
    console.log('Test summary:', results);
  })();

  // 初期描画
  render();
  </script>
</body>
</html>
