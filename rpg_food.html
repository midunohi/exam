<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ç‹©ã‚Š(è‹±å˜èª 4æŠ)</title>
<style>
  :root{--bg:#0b1020;--panel:#16223d;--fg:#e5e7eb;--ok:#22c55e;--bad:#ef4444;--muted:#94a3b8}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo,sans-serif;background:var(--bg);color:var(--fg)}

  #wrap{position:relative;width:100vw;height:100vh;overflow:hidden}
  #ui{position:absolute;inset:0;display:flex;flex-direction:column;gap:10px;padding:10px}

  .row{display:flex;gap:10px;align-items:center}
  .grow{flex:1}
  .label{opacity:.8}
  .val{opacity:.9}
  .bar{height:14px;min-width:260px;background:#0a1429;border-radius:8px;overflow:hidden}
  .bar>span{display:block;height:100%;width:0;transition:width .25s}
  .hp>span{background:#b91c1c}
  .exp>span{background:#0ea5e9}

  #top{display:flex;justify-content:space-between;align-items:flex-start}
  #hero,#enemy{display:flex;flex-direction:column;gap:6px;background:rgba(22,34,61,.6);padding:8px;border-radius:10px}

  #qa{display:flex;flex-direction:column;align-items:center;gap:8px;margin:0 auto;max-width:min(900px,94vw)}
  #question{font-size:18px;text-align:center}
  #choices{display:grid;grid-template-columns:1fr 1fr;gap:8px;width:100%}
  button.choice{background:#1b2947;color:var(--fg);border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:10px;font-size:16px;cursor:pointer}
  button.choice:disabled{opacity:.6;cursor:default}

  #logWrap{display:none}
  #log{height:22vh;overflow:auto;font-size:14px}
  #log p{margin:.35em 0}
  .ok{color:var(--ok)} .bad{color:var(--bad)}

  #btns{display:none}
  #btns button{background:#1b2947;color:var(--fg);border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:8px 12px;cursor:pointer}

  #stageSvg{position:absolute;inset:0;width:100%;height:100%;display:block}
  #enemyG.hit #enemyBody{animation:flash .2s 3}
  @keyframes flash{50%{filter:brightness(2)}}
</style>
</head>
<body>
<section id="wrap">
  <svg id="stageSvg" viewBox="0 0 960 540" preserveAspectRatio="xMidYMid slice" aria-hidden="true">
    <rect x="0" y="0" width="960" height="540" fill="#0e1a33"/>
    <rect x="0" y="360" width="960" height="180" fill="#0a1429"/>
    <g id="enemyG" transform="translate(720,360)">
      <ellipse id="enemyBody" cx="0" cy="0" rx="90" ry="54" fill="#3d8f7c"/>
      <circle cx="-28" cy="-8" r="10" fill="#13252a"/>
      <circle cx="28" cy="-8" r="10" fill="#13252a"/>
    </g>
  </svg>

  <div id="ui">
    <div id="top">
      <div id="hero">
        <div class="row"><span class="label">Lv</span><span id="lv" class="val">1</span><span class="label" style="margin-left:auto">Stage</span><span id="stage" class="val">1-1</span></div>
        <div class="row"><span class="label">EXP</span><div class="bar exp grow"><span id="expBar"></span></div><span id="expText" class="val">0 / 20</span></div>
        <div class="row"><span class="label">HP</span><div class="bar hp grow"><span id="hpBar"></span></div><span id="hpText" class="val">30 / 30</span></div>
        <div class="row"><span class="label">ATK</span><span id="atk" class="val">5</span></div>
      </div>
      <div id="enemy">
        <div class="row"><span class="label">ENEMY</span><span id="enemyName" class="val">æ•µ</span></div>
        <div class="row"><span class="label">HP</span><div class="bar hp grow"><span id="enemyHpBar"></span></div><span id="enemyHpText" class="val">0 / 0</span></div>
      </div>
    </div>

    <div id="qa">
      <div id="question">â€”</div>
      <div id="choices"></div>
    </div>

    <div id="logWrap">
      <div id="log"></div>
      <div id="btns">
        <button id="nextBtn" style="display:none">æ¬¡ã®æ•µã¸ â–¶</button>
        <button id="retryBtn" style="display:none">ãƒªãƒˆãƒ©ã‚¤ âŸ³</button>
      </div>
    </div>
  </div>
</section>

<script>
(()=>{
  'use strict';
  // ===== å¤‰æ•°å®£è¨€ï¼ˆTDZå›é¿ï¼‰ =====
  let Q = null; // ç¾åœ¨ã®å•é¡Œ
  const S = { world:1, local:1, lv:1, exp:0, totalExp:0, nextExp:20, atk:5, hp:30, maxHP:30, enemy:null, pool:[], used:new Set() };
  const EXP_KEY = 'midunohi.exam.exp';

  // ===== ãƒ‡ãƒ¼ã‚¿ï¼šé£Ÿã¹ç‰©ãƒ†ãƒ¼ãƒ =====
  const WORDS=[
    {jp:'é¦™è‰',ans:'herbs',opts:['verbs','herds','herbs','herbs.']},
    {jp:'èª¿å‘³æ–™',ans:'seasoning',opts:['seasoning','season','seasoned','seizing']},
    {jp:'ä¿å­˜æ–™',ans:'preservative',opts:['preservative','preservation','preserver','preserve']},
    {jp:'ç™ºé…µ',ans:'fermentation',opts:['fermentation','ferment','fermentatione','fragmentation']},
    {jp:'å…¨ç²’ç²‰',ans:'whole grain',opts:['whole grain','whole train','whole drain','whole grainy']},
    {jp:'ç²¾è£½ç³–',ans:'refined sugar',opts:['refining sugar','refined sugar','refined sugars','refinery sugar']},
    {jp:'ç‚­æ°´åŒ–ç‰©',ans:'carbohydrates',opts:['carbonhydrates','carbohydrates','carbo-hydrates','carbohydrate']},
    {jp:'é£Ÿç‰©ç¹Šç¶­',ans:'dietary fiber',opts:['dietary fiber','diet fiber','dietary fibres','dietary fibber']},
    {jp:'é£½å’Œè„‚è‚ª',ans:'saturated fat',opts:['saturated fats','saturate fat','saturated fat','saturation fat']},
    {jp:'ä¸é£½å’Œè„‚è‚ª',ans:'unsaturated fat',opts:['unsaturate fat','unsaturated fat','unsaturation fat','insaturated fat']},
    {jp:'ç²¾ç™½ç±³',ans:'white rice',opts:['whit rice','white lice','white rise','white rice']},
    {jp:'ç„ç±³',ans:'brown rice',opts:['brown lice','brown rise','bran rice','brown rice']},
    {jp:'ç™ºèŠ½',ans:'sprouting',opts:['spouting','sprout','sprouting','sprouted']},
    {jp:'ä½ç³–è³ª',ans:'low-carb',opts:['low-carb','low-carve','low-carbon','slow-carb']},
    {jp:'ä½è„‚è‚ª',ans:'low-fat',opts:['low-fate','low-fat','low-fats','low fact']},
    {jp:'é«˜ã‚¿ãƒ³ãƒ‘ã‚¯',ans:'high-protein',opts:['high-protein','height protein','high proteins','hy-protein']}
  ];
  const ENEMIES=[
    {name:'ã‚¹ãƒ©ã‚¤ãƒ ', hp:28, atk:[3,6]},
    {name:'ã‚¦ãƒ«ãƒ•', hp:40, atk:[5,9]},
    {name:'ã‚ªãƒ¼ã‚¬', hp:65, atk:[8,14]}
  ];

  // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  const rand=n=>Math.floor(Math.random()*n);
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  const setBar=(id,ratio)=>{const el=document.getElementById(id); if(el) el.style.width=(100*clamp(ratio,0,1)).toFixed(1)+'%';}
  const log=html=>{const el=document.getElementById('log'); el.insertAdjacentHTML('beforeend',`<p>${html}</p>`); el.scrollTop=el.scrollHeight;}
  const shuffle=a=>{ for(let i=a.length-1;i>0;i--){ const j=rand(i+1); [a[i],a[j]]=[a[j],a[i]]; } return a; };

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åŸºç¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’åˆæœŸå€¤ã«æˆ»ã™
  function resetStatsBase(){
    S.lv = 1;
    S.exp = 0;
    S.nextExp = 20;
    S.atk = 5;
    S.maxHP = 30;
    S.hp = S.maxHP;
  }

  // åˆè¨ˆ EXP ã‹ã‚‰ãƒ¬ãƒ™ãƒ«ãƒ»ç¾åœ¨ EXP ã‚’å†æ§‹ç¯‰ã™ã‚‹
  function applyTotalExp(total){
    resetStatsBase();
    S.totalExp = total;
    let remain = total;
    while(remain > 0){
      const need = S.nextExp - S.exp;
      if(remain >= need){
        S.exp += need;
        remain -= need;
        levelUp();
        S.exp = 0; // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—å¾Œã®ä½™ã‚Šã¯ 0 ã‹ã‚‰å†ã‚¹ã‚¿ãƒ¼ãƒˆ
      }else{
        S.exp += remain;
        remain = 0;
      }
    }
  }

  // ===== åˆæœŸåŒ– =====
  window.addEventListener('DOMContentLoaded', init, {once:true});
  function init(){
    // === åˆè¨ˆ EXP ã‚’ localStorage ã‹ã‚‰å¾©å…ƒ ===
    try{
      const raw = localStorage.getItem(EXP_KEY);
      if(raw !== null){
        const total = parseInt(raw, 10);
        if(Number.isFinite(total) && total >= 0){
          applyTotalExp(total);
        }else{
          resetStatsBase();
          S.totalExp = 0;
        }
      }else{
        resetStatsBase();
        S.totalExp = 0;
      }
    }catch(e){
      console.warn('localStorage èª­ã¿è¾¼ã¿å¤±æ•—', e);
      resetStatsBase();
      S.totalExp = 0;
    }

    S.pool=[...WORDS];
    spawnEnemy();
    renderHUD(); // â† å¾©å…ƒã—ãŸ EXP / ãƒ¬ãƒ™ãƒ« ã‚’åæ˜ 
    nextQuestion();
    document.getElementById('nextBtn').addEventListener('click', nextStage);
    document.getElementById('retryBtn').addEventListener('click', function(){ S.hp=S.maxHP; renderHUD(); spawnEnemy(); this.style.display='none'; });
    smokeTests();
  }

  // ===== æ•µç”Ÿæˆ =====
  function spawnEnemy(){
    const base=ENEMIES[Math.min(ENEMIES.length-1, Math.floor((S.local-1)/2))];
    const scale=1+(S.world-1)*0.25+(S.local-1)*0.1;
    S.enemy={name: base.name+(scale>1.2?'ï¼ˆå¼·åŒ–ï¼‰':''), maxHP:Math.round(base.hp*scale)};
    S.enemy.hp=S.enemy.maxHP;
    S.enemy.atkMin=Math.round(base.atk[0]*scale);
    S.enemy.atkMax=Math.round(base.atk[1]*scale);
    document.getElementById('enemyName').textContent=S.enemy.name;
    document.getElementById('stage').textContent=`${S.world}-${S.local}`;
    updateEnemyHUD();
    log(`ğŸ‘¾ ${S.enemy.name} ãŒç¾ã‚ŒãŸï¼ï¼ˆHP ${S.enemy.hp}ï¼‰`);
  }

  // ===== HUD =====
  function renderHUD(){
    document.getElementById('lv').textContent=S.lv;
    document.getElementById('atk').textContent=S.atk;
    document.getElementById('hpText').textContent=`${S.hp} / ${S.maxHP}`;
    document.getElementById('expText').textContent=`${S.exp} / ${S.nextExp}`;
    setBar('hpBar', S.hp/S.maxHP);
    setBar('expBar', S.exp/S.nextExp);
  }
  function updateEnemyHUD(){
    document.getElementById('enemyHpText').textContent=`${S.enemy.hp} / ${S.enemy.maxHP}`;
    setBar('enemyHpBar', S.enemy.hp/S.enemy.maxHP);
  }

  // ===== ã‚¯ã‚¤ã‚º =====
  function nextQuestion(){
    const remain=S.pool.map((_,i)=>i).filter(i=>!S.used.has(i));
    if(remain.length===0){ S.used.clear(); return nextQuestion(); }
    const pick=remain[rand(remain.length)];
    S.used.add(pick);
    const base=S.pool[pick];
    const opts=[...new Set(base.opts)];
    if(!opts.includes(base.ans)) opts[rand(opts.length)]=base.ans;
    Q = { jp: base.jp, ans: base.ans, choices: shuffle(opts) };
    document.getElementById('question').textContent=`ã€é£Ÿã¹ç‰©ã€‘ã€Œ${Q.jp}ã€ã®è‹±èªã¯ã©ã‚Œï¼Ÿ`;
    const area=document.getElementById('choices');
    area.innerHTML='';
    Q.choices.forEach(w=>{
      const b=document.createElement('button');
      b.className='choice';
      b.textContent=w;
      b.addEventListener('click',()=>answer(w));
      area.appendChild(b);
    });
  }

  // ===== æˆ¦é—˜ =====
  const pAtk=()=>{ const v=Math.max(1,Math.floor(S.atk*0.5)); return S.atk+rand(v+1); };
  const eAtk=()=> S.enemy.atkMin+rand(S.enemy.atkMax-S.enemy.atkMin+1);
  function answer(choice){
    if(!Q){ console.warn('Q not ready yet'); return; }
    const ok=(choice===Q.ans);
    document.querySelectorAll('button.choice').forEach(b=>b.disabled=true);
    if(ok){
      const d=pAtk();
      S.enemy.hp=clamp(S.enemy.hp-d,0,S.enemy.maxHP);
      document.getElementById('enemyG').classList.add('hit');
      setTimeout(()=>document.getElementById('enemyG').classList.remove('hit'),220);
      log(`âœ… æ­£è§£ï¼ <span class="ok">${d} ãƒ€ãƒ¡ãƒ¼ã‚¸</span>`);
      updateEnemyHUD();
    }else{
      const d=eAtk();
      S.hp=clamp(S.hp-d,0,S.maxHP);
      log(`âŒ ä¸æ­£è§£â€¦ <span class="bad">${d} ãƒ€ãƒ¡ãƒ¼ã‚¸</span>`);
    }
    renderHUD();
    checkEnd();
    if(!isOver()) setTimeout(nextQuestion,280);
  }
  const isOver=()=> S.hp<=0 || S.enemy.hp<=0;
  function checkEnd(){
    if(S.enemy.hp<=0){
      const xp=Math.ceil(10+S.world*3+S.local*2);
      log(`ğŸ† <span class="ok">æ’ƒç ´ï¼</span> +${xp} EXP`);
      addExp(xp);
      document.getElementById('nextBtn').style.display='inline-block';
      document.getElementById('retryBtn').style.display='none';
    }else if(S.hp<=0){
      log('<span class="bad">å€’ã‚Œã¦ã—ã¾ã£ãŸâ€¦</span>');
      document.getElementById('nextBtn').style.display='none';
      document.getElementById('retryBtn').style.display='inline-block';
    }
  }
  function addExp(x){ 
    if(x <= 0) return;

    // åˆè¨ˆ EXP ã‚’å…ˆã«åŠ ç®—
    S.totalExp += x;

    // ç¾åœ¨ãƒ¬ãƒ™ãƒ«ç”¨ã® EXP ã‚²ãƒ¼ã‚¸ã«åæ˜ 
    let remain = x;
    while(remain > 0){
      const need = S.nextExp - S.exp;
      if(remain >= need){
        S.exp += need;
        remain -= need;
        levelUp();
        S.exp = 0; // æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã®ãŸã‚ã«ä½™ã‚Šã¯ 0 ã‹ã‚‰
      }else{
        S.exp += remain;
        remain = 0;
      }
    }

    // === åˆè¨ˆ EXP ã‚’ localStorage ã«ä¿å­˜ ===
    try{
      localStorage.setItem(EXP_KEY, String(S.totalExp));
    }catch(e){ console.warn('localStorage ä¿å­˜å¤±æ•—', e); }

    renderHUD(); 
  }
  function levelUp(){ S.lv++; const hpG=8+Math.floor(S.lv*1.5); const atkG=2; S.maxHP+=hpG; S.hp=S.maxHP; S.atk+=atkG; S.nextExp=Math.round(S.nextExp*1.35); log(`âœ¨ <span class=ok>ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼</span> Lv${S.lv} / HP+${hpG} / ATK+${atkG}`); }
  function nextStage(){ S.local++; if(S.local>5){ S.local=1; S.world++; } spawnEnemy(); document.getElementById('nextBtn').style.display='none'; nextQuestion(); }

  // ===== ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆï¼ˆæ—¢å­˜ç¶­æŒï¼‹è¿½åŠ ï¼‰ =====
  function smokeTests(){
    try{
      console.assert(typeof Q !== 'undefined', 'Q ãŒæœªå®šç¾©ï¼ˆTDZï¼‰ã§ã™');
      setTimeout(()=>{
        console.assert(Q && Q.jp && Q.ans, 'Q ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        const choices=document.querySelectorAll('#choices .choice');
        console.assert(choices.length===4, `é¸æŠè‚¢ãŒ4ã¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“: ${choices.length}`);
        console.assert(Array.isArray(WORDS) && WORDS.length>=12, `ãƒ•ãƒ¼ãƒ‰å˜èªã®ãƒ‡ãƒ¼ã‚¿æ•°ãŒä¸è¶³: ${WORDS.length}`);
        console.assert(document.getElementById('question').textContent.startsWith('ã€é£Ÿã¹ç‰©ã€‘'), 'å•é¡Œã«ã€é£Ÿã¹ç‰©ã€‘ãƒ©ãƒ™ãƒ«ãŒç„¡ã„');
        console.assert(S.enemy && S.enemy.hp>0, 'æ•µHPãŒæ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        console.assert(document.getElementById('nextBtn') && document.getElementById('retryBtn'), 'ãƒœã‚¿ãƒ³ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
        // EXP è¡¨ç¤ºã®ãƒã‚§ãƒƒã‚¯ï¼ˆæ•°å€¤ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ï¼‰
        const expText = document.getElementById('expText').textContent;
        console.assert(expText.startsWith(String(S.exp)), `EXP è¡¨ç¤ºãŒçŠ¶æ…‹ã¨ä¸€è‡´ã—ã¾ã›ã‚“: ${expText} vs ${S.exp}`);
        console.log('[SmokeTests] OK');
      }, 0);
    }catch(e){ console.warn('[SmokeTests] å¤±æ•—:', e); }
  }
})();
</script>
</body>
</html>
