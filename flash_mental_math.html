<!doctype html>
<html lang="ja">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>フラッシュ暗算（足し算）</title>
<style>
  body{margin:0;min-height:100vh;display:grid;place-items:center;font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;background:#0b1020;color:#eef2ff}
  .box{width:min(520px,92vw);padding:18px;border:1px solid #ffffff22;border-radius:16px;background:#121a33cc}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input,button{font:inherit;border-radius:12px;border:1px solid #ffffff22;background:#0c1226;color:#eef2ff;padding:10px 12px}
  input{width:110px}
  button{cursor:pointer;background:#2a3a66}
  button:disabled{opacity:.5;cursor:not-allowed}
  #n{font-size:72px;font-weight:900;letter-spacing:.02em;text-align:center;padding:18px 0}
  #hint{font-size:12px;color:#b8c3ea;text-align:center}
  #msg{margin-top:10px;font-weight:700;text-align:center}
</style>

<div class="box">
  <div class="row">
    <label>個数 <input id="k" type="number" min="2" max="200" value="5"></label>
    <label>桁 <input id="d" type="number" min="1" max="6" value="1"></label>
    <label>間隔ms（1秒=1000） <input id="ms" type="number" min="50" max="3000" value="1000"></label>
    <button id="start">開始</button>
    <button id="reset">リセット</button>
  </div>

  <div id="n">—</div>
  <div id="hint">開始 → 数字が次々表示 → 最後に合計を入力してEnter</div>

  <div class="row" style="justify-content:center;margin-top:10px">
    <input id="ans" inputmode="numeric" placeholder="合計" disabled>
  </div>
  <div id="msg"></div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const kEl=$('k'), dEl=$('d'), msEl=$('ms');
  const startBtn=$('start'), resetBtn=$('reset');
  const nEl=$('n'), ansEl=$('ans'), msgEl=$('msg');

  let seq=[], sum=0, i=0, t=null, running=false;

  const randInt=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const rangeForDigits=(d)=>{
    d=Math.max(1,Math.min(6,Number(d)||1));
    return d===1 ? [0,9] : [10**(d-1), 10**d-1];
  };

  function setRunning(on){
    running=on;
    startBtn.disabled=on;
    kEl.disabled=on; dEl.disabled=on; msEl.disabled=on;
    ansEl.disabled=on; // 走ってる間は入力不可
  }

  function clearTimer(){ if(t){ clearTimeout(t); t=null; } }

  function reset(){
    clearTimer();
    seq=[]; sum=0; i=0;
    nEl.textContent='—';
    ansEl.value='';
    ansEl.disabled=true;
    msgEl.textContent='';
    setRunning(false);
  }

  function showNext(){
    if(i>=seq.length){
      nEl.textContent='?';
      ansEl.disabled=false;
      ansEl.focus();
      setRunning(false);
      return;
    }
    nEl.textContent=String(seq[i]);
    i++;
    t=setTimeout(showNext, Math.max(50, Number(msEl.value)||300));
  }

  function start(){
    reset();
    const k=Math.max(2, Math.min(200, Number(kEl.value)||10));
    const [lo,hi]=rangeForDigits(dEl.value);
    seq=Array.from({length:k},()=>randInt(lo,hi));
    sum=seq.reduce((a,b)=>a+b,0);
    i=0;
    msgEl.textContent='';
    setRunning(true);
    showNext();
  }

  function parseNum(s){
    s=(s||'').trim()
      .replace(/[０-９]/g,ch=>String(ch.charCodeAt(0)-0xFF10))
      .replace(/[－ー−]/g,'-');
    if(!s) return null;
    const n=Number(s);
    return Number.isFinite(n) ? n : null;
  }

  ansEl.addEventListener('keydown', (e)=>{
    if(e.key!=='Enter') return;
    e.preventDefault();
    const u=parseNum(ansEl.value);
    if(u===null){ msgEl.textContent='数字を入力してください'; return; }
    msgEl.textContent = (u===sum) ? '正解！✨' : `不正解… 正解は ${sum}`;
  });

  startBtn.addEventListener('click', start);
  resetBtn.addEventListener('click', reset);
  window.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){ e.preventDefault(); reset(); }
  });

  reset();
})();
</script>
</html>