<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>è‹±èªã‚¹ãƒ”ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient( rgba(5, 8, 20, 0.75), rgba(5, 8, 20, 0.9)), url("img/bg_fc_enExamples.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      color: #fff;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      align-items: center;
      justify-content: center;
      padding: 12px;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 16px;
      text-align: center;
      font-weight: 600;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      align-items: center;
      margin-bottom: 12px;
      font-size: 12px;
    }
    .exp {
      color: #9ca3af;
      font-size: 12px;
    }
    input[type="range"] { font-size: 12px; }
    button {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      background: #2563eb;
      color: #fff;
      user-select: none;
    }
    button.secondary { background:#111; border:1px solid #333; }
    .word-box {
      width: 100%;
      max-width: 600px;
      height: min(55vh, 260px);
      border-radius: 16px;
      border: 1px solid #222;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 12px;
    }
    .word {
      font-size: clamp(24px, 5vw, 40px);
      text-align: center;
      letter-spacing: 0.04em;
      white-space: nowrap;
    }
    .status {
      margin-top: 6px;
      font-size: 11px;
      text-align: center;
      opacity: .7;
    }
  </style>
</head>
<body>
  <div>
    <h1>è‹±èªã‚¹ãƒ”ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°</h1>

    <div class="controls">
      <button id="playPauseBtn">â–¶ï¸</button>
      <button id="randomBtn" class="secondary">ğŸ² ä¾‹æ–‡ãƒ©ãƒ³ãƒ€ãƒ </button>

      <label>
        é€Ÿåº¦
        <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ã€Œãƒã‚¤ãƒ†ã‚£ãƒ–ã‚ˆã‚Šé€Ÿããªã„ã€ç¯„å›²ã®å­¦ç¿’å‘ã‘ã«èª¿æ•´ -->
        <input type="range" id="speedSlider" min="120" max="500" step="10" value="240" />
        <span id="speedLabel">240 wpm</span>
      </label>
      <span class="exp">EXP: <span id="expLabel">0</span></span>
    </div>

    <div class="word-box">
      <div id="wordDisplay" class="word">æº–å‚™ä¸­â€¦</div>
    </div>
    <div class="status" id="statusLabel">0 / 0ã€€åœæ­¢ä¸­</div>
  </div>

  <script>
    const passages = [
      "Reading is a skill that you can improve through practice. When you read English every day, you gradually get used to common phrases and sentence patterns. This makes it easier to understand long passages in entrance exams. Try to focus on the meaning of each group of words rather than translating word by word.",
      "Technology has changed the way we communicate with each other. In the past, people had to write letters and wait many days for a reply. Today, we can send messages instantly by email or social media. However, some researchers say that we may be losing deep conversations because we are always online.",
      "Many students believe that they must study for long hours without a break. In fact, short and focused study sessions are often more effective. When you review important points regularly, the information moves from short term memory to long term memory. This method is useful when you prepare for university entrance exams."
    ];

    const playPauseBtn = document.getElementById('playPauseBtn');
    const randomBtn    = document.getElementById('randomBtn');
    const speedSlider  = document.getElementById('speedSlider');
    const speedLabel   = document.getElementById('speedLabel');
    const wordDisplay  = document.getElementById('wordDisplay');
    const statusLabel  = document.getElementById('statusLabel');

    const EXP_KEY = "midunohi.exam.exp";
    let exp = 0;
    let expAwarded = false;
    let words = [];
    let index = 0;
    let running = false;
    let timerId = null;
    let lastPick = -1;

    function loadExp() {
      try {
        const stored = localStorage.getItem(EXP_KEY);
        const n = Number(stored || 0);
        exp = Number.isFinite(n) && n >= 0 ? Math.floor(n) : 0;
      } catch (e) {
        exp = 0;
      }
      updateExpDisplay();
    }

    function saveExp() {
      try {
        localStorage.setItem(EXP_KEY, String(exp));
      } catch (e) {
        /* noop */
      }
      updateExpDisplay();
    }

    function updateExpDisplay() {
      const el = document.getElementById("expLabel");
      if (el) el.textContent = String(exp);
    }

    function wpmToIntervalMs(wpm) {
      return 60000 / Math.max(1, wpm);
    }

    function updateSpeedLabel() {
      const wpm = Number(speedSlider.value);
      speedLabel.textContent = wpm + " wpm";
      if (running) startTimer();
    }

    function updateDisplay() {
      if (!words.length) {
        wordDisplay.textContent = "ä¾‹æ–‡ã‚’ãƒ©ãƒ³ãƒ€ãƒ é¸æŠã—ã¦ãã ã•ã„";
        statusLabel.textContent = "0 / 0ã€€åœæ­¢ä¸­";
        return;
      }
      const current = Math.min(index + 1, words.length);
      wordDisplay.textContent = words[index] || "";
      statusLabel.textContent = current + " / " + words.length + (running ? "ã€€å†ç”Ÿä¸­" : "ã€€åœæ­¢ä¸­");
    }

    function setWordsFromText(text) {
      words = (text || "").split(/\s+/).filter(Boolean);
      index = 0;
      expAwarded = false;
      updateDisplay();
    }

    function pickRandomPassage() {
      if (!passages.length) return "";
      if (passages.length === 1) return passages[0];

      // é€£ç¶šã§åŒã˜ä¾‹æ–‡ã«ãªã‚Šã«ããã™ã‚‹
      let k = Math.floor(Math.random() * passages.length);
      if (k === lastPick) k = (k + 1) % passages.length;
      lastPick = k;
      return passages[k];
    }

    function randomizePassage() {
      pause();                 // å†é¸æŠæ™‚ã¯åœæ­¢ã—ã¦æœ€åˆã‹ã‚‰ã«ã™ã‚‹
      setWordsFromText(pickRandomPassage());
    }

    function advance() {
      if (!running || !words.length) return;
      index++;
      if (index >= words.length) {
        if (!expAwarded) {
          exp += 5;
          expAwarded = true;
          saveExp();
        }
        pause();
        index = Math.max(0, words.length - 1);
      }
      updateDisplay();
    }

    function startTimer() {
      if (timerId) {
        clearTimeout(timerId);
        timerId = null;
      }
      if (!running || !words.length) return;

      const interval = wpmToIntervalMs(Number(speedSlider.value));
      timerId = setTimeout(function tick() {
        if (!running || !words.length) return;
        advance();
        if (!running || !words.length) return;
        timerId = setTimeout(tick, wpmToIntervalMs(Number(speedSlider.value)));
      }, interval);
    }

    function play() {
      if (!words.length) randomizePassage();
      if (!words.length) return;

      running = true;
      playPauseBtn.textContent = "â¸";
      if (index >= words.length) {
        index = 0;
        expAwarded = false;
      }
      updateDisplay();
      startTimer();
    }

    function pause() {
      running = false;
      playPauseBtn.textContent = "â–¶ï¸";
      if (timerId) {
        clearTimeout(timerId);
        timerId = null;
      }
      updateDisplay();
    }

    // UI events
    playPauseBtn.addEventListener("click", () => {
      running ? pause() : play();
    });

    randomBtn.addEventListener("click", () => {
      randomizePassage();
    });

    speedSlider.addEventListener("input", updateSpeedLabel);

    // Key controls
    document.addEventListener("keydown", (e) => {
      // Space: play/pause, R: randomize, â†‘â†“: speed
      if (e.code === "Space") {
        e.preventDefault();
        running ? pause() : play();
      } else if (e.key === "r" || e.key === "R") {
        e.preventDefault();
        randomizePassage();
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        const v = Math.min(Number(speedSlider.max), Number(speedSlider.value) + 20);
        speedSlider.value = v;
        updateSpeedLabel();
      } else if (e.key === "ArrowDown") {
        e.preventDefault();
        const v = Math.max(Number(speedSlider.min), Number(speedSlider.value) - 20);
        speedSlider.value = v;
        updateSpeedLabel();
      }
    });

    // åˆæœŸåŒ–ï¼šèµ·å‹•æ™‚ã«ãƒ©ãƒ³ãƒ€ãƒ ä¾‹æ–‡ã‚’ã‚»ãƒƒãƒˆï¼ˆåœæ­¢çŠ¶æ…‹ï¼‰
    loadExp();
    updateSpeedLabel();
    randomizePassage();
  </script>
</body>
</html>
