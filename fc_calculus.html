<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flashcards: Calculus Formulas</title>
  <style>
    :root{ --bg:#0f172a; --panel:#0a0f1a; --card:#0b1220; --border:#1f2937; --fg:#e5e7eb; --muted:#9ca3af; --acc:#22d3ee; --good:#34d399; --warn:#fda4af; }
    html,body{height:100%; margin:0; background: radial-gradient(70rem 60rem at 50% -10%, #0b1220 0%, var(--bg) 40%, #070b14 100%); font-family: system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;}
    .container{max-width:960px; margin:0 auto; padding:16px 16px 72px;}
    header{display:flex; gap:12px; align-items:center; justify-content:space-between; color:var(--fg); margin-top:12px}
    header .title{font-weight:800; letter-spacing:.3px; white-space:normal; word-break:break-word; line-height:1.25}
    .card{margin-top:14px; background:linear-gradient(180deg,#0a1322,#0a0f1a); border:1px solid var(--border); border-radius:20px; padding:24px; display:grid; grid-template-columns:1fr; gap:14px; align-items:start; box-shadow:0 10px 30px rgba(0,0,0,.35);}    
    .formula-row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .label{font-size:20px; color:var(--muted); font-weight:700; margin-right:4px}
    .lhs{font-size:26px; color:var(--fg);}    
    .rhs{font-size:26px; color:var(--acc);} /* 右辺は薄い青 */
    .eq{font-size:26px; color:var(--fg)}
    .ph{font-size:26px; color:var(--warn); opacity:.9}

    /* 例題: 1行表示 */
    .examples{display:flex; flex-direction:column; gap:6px}
    .ex-line{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .ex-label{font-size:16px; color:var(--muted); font-weight:700; margin-right:4px}
    .ex-q{font-size:18px; color:var(--fg)}
    .ex-eq{font-size:18px; color:var(--fg)}
    .ex-a{font-size:18px; color:var(--acc)}
    .ex-ph{font-size:18px; color:var(--warn); opacity:.9}

    /* 互換用の旧1例題行はUIでは非表示（重複回避） */
    #exampleInline{ display:none }

    .foot{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:6px; color:var(--muted); flex-wrap:wrap}
    .meters{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .meter{display:flex; align-items:center; gap:8px}
    .bar{position:relative; width:220px; height:10px; background:#0c1220; border:1px solid var(--border); border-radius:999px; overflow:hidden}
    .fill{position:absolute; inset:0; width:0%; background:linear-gradient(90deg, var(--acc), var(--good)); box-shadow:0 0 20px rgba(34,211,238,.4) inset}
    .count{font-weight:700; color:var(--fg)}
    .hint{font-size:12px; color:var(--muted)}
    a.back{color:var(--acc); text-decoration:none; font-size:14px}
  </style>
  <!-- MathJax for TeX rendering -->
  <script>
    window.MathJax = { tex: { inlineMath: [['$','$'], ['\\(','\\)']] }, svg: { fontCache: 'global' } };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">Calculus Flashcards<br/>微積の公式（左辺=問題／右辺=答え）+ 例題（=で結ぶ）</div>
    </header>

    <section class="card" aria-live="polite" id="card" tabindex="0">
      <div class="formula-row">
        <div class="label">公式:</div>
        <div class="lhs" id="lhs">...</div>
        <div class="eq" id="eq">=</div>
        <div class="rhs" id="rhs"></div>
        <div class="ph" id="rhsPh">???</div>
      </div>
      <!-- 旧単一例題（互換）: UI非表示だがDOMは維持 -->
      <div class="ex-line" id="exampleInline">
        <div class="ex-label">例題:</div>
        <div class="ex-q" id="exq"></div>
        <div class="ex-eq">=</div>
        <div class="ex-a" id="exa"></div>
        <div class="ex-ph" id="exaPh">???</div>
      </div>
      <!-- 複数例題を1行ずつ描画 -->
      <div class="examples" id="exlist"></div>

      <div class="foot">
        <div class="meters" aria-live="polite">
          <div class="meter" title="この周回の進捗">
            <span class="badge">Cycle</span>
            <div class="bar" aria-label="Cycle Progress" role="progressbar" aria-valuemin="0" aria-valuemax="10" aria-valuenow="0">
              <div class="fill" id="cycleFill"></div>
            </div>
            <span class="badge" id="cycleText">0 / 10</span>
          </div>
          <div class="meter" title="表示回数">
            <span class="badge">Reveals</span>
            <span class="count" id="revealCount">0</span>
          </div>
        </div>
        <div id="progress">0 / 0</div>
        <div class="hint">タップ/クリック：順に解答を表示 → すべて表示後は次へ（Space/Enter/→も可）</div>
      </div>
    </section>
  </div>
  <div style="padding:16px; max-width:960px; margin:0 auto"><a class="back" href="index.html">戻る</a></div>

  <script>
  // =============================
  // Data
  // =============================
  const dataset = [
    { lhs: "$\\frac{d}{dx} x^n$", rhs: "$n x^{n-1}$", examples:[
      {q: "$\\frac{d}{dx}\\, x^5$", a: "$5x^4$"},
      {q: "$\\frac{d}{dx}\\, x^{-2}$", a: "$-2x^{-3}$"}
    ] },
    { lhs: "$\\frac{d}{dx} (u+v)$", rhs: "$u' + v'$", examples:[
      {q: "$\\frac{d}{dx}(x^2+\\sin x)$", a: "$2x+\\cos x$"},
      {q: "$\\frac{d}{dx}(e^x+\\ln x)$", a: "$e^x+\\tfrac{1}{x}$"}
    ] },
    { lhs: "$\\frac{d}{dx} (uv)$", rhs: "$u v' + u' v$", examples:[
      {q: "$\\frac{d}{dx}(x^2 e^x)$", a: "$2x e^x + x^2 e^x$"},
      {q: "$\\frac{d}{dx}(x\\sin x)$", a: "$x\\cos x + \\sin x$"}
    ] },
    { lhs: "$\\frac{d}{dx}\\left( \\frac{u}{v} \\right)$", rhs: "$\\frac{u' v - u v'}{v^2}$", examples:[
      {q: "$\\frac{d}{dx}\\left( \\frac{\\ln x}{x} \\right)$", a: "$\\frac{1-\\ln x}{x^2}$"},
      {q: "$\\frac{d}{dx}\\left( \\frac{e^x}{x} \\right)$", a: "$\\frac{xe^x-e^x}{x^2}$"}
    ] },
    { lhs: "$\\frac{d}{dx} f(g(x))$", rhs: "$f'(g(x))\\, g'(x)$", examples:[
      {q: "$\\frac{d}{dx} \\sin(x^2)$", a: "$2x\\cos(x^2)$"},
      {q: "$\\frac{d}{dx} e^{x^2}$", a: "$2x e^{x^2}$"}
    ] },
    { lhs: "$\\frac{d}{dx} e^x$", rhs: "$e^x$", examples:[
      {q: "$\\frac{d}{dx} (e^{3x})$", a: "$3e^{3x}$"},
      {q: "$\\frac{d}{dx} (e^{-x})$", a: "$-e^{-x}$"}
    ] },
    { lhs: "$\\frac{d}{dx} \\ln x$", rhs: "$\\frac{1}{x}$ ( $x>0$ )", examples:[
      {q: "$\\frac{d}{dx}\\ln(x^2+1)$", a: "$\\frac{2x}{x^2+1}$"},
      {q: "$\\frac{d}{dx}\\ln(\\sin x)$", a: "$\\cot x$"}
    ] },
    { lhs: "$\\int x^m \\; dx$", rhs: "$\\frac{x^{m+1}}{m+1} + C \\; (m\\neq -1)$", examples:[
      {q: "$\\int x^2 dx$", a: "$\\frac{x^3}{3}+C$"},
      {q: "$\\int x^{-2} dx$", a: "$-x^{-1}+C$"}
    ] },
    { lhs: "$\\int \\cos x \\; dx$", rhs: "$\\sin x + C$", examples:[
      {q: "$\\int \\cos(2x) dx$", a: "$\\tfrac{1}{2}\\sin(2x)+C$"},
      {q: "$\\int \\cos x \\; e^x dx$", a: "$\\tfrac{1}{2}e^x(\\sin x+\\cos x)+C$"}
    ] },
    { lhs: "$\\int u \\; dv$", rhs: "$uv - \\int v \\; du$ (部分積分)", examples:[
      {q: "$\\int x e^x dx$", a: "$x e^x - e^x + C$"},
      {q: "$\\int x \\cos x \\; dx$", a: "$x \\sin x + \\cos x + C$"}
    ] },
    { lhs: "$\\int f'(g(x))g'(x)dx$", rhs: "$f(g(x))+C$ (置換積分)", examples:[
      {q: "$\\int 2x \\cos(x^2) dx$", a: "$\\sin(x^2)+C$"},
      {q: "$\\int \\frac{2x}{x^2+1} dx$", a: "$\\ln(x^2+1)+C$"}
    ] }
  ];

  // =============================
  // State
  // =============================
  let idx = 0;
  let revealStep = 0; // 0: all hidden, 1: RHS, 2..: examples answers one by one
  let revealTotal = Number(localStorage.getItem('revealTotal')||0);
  let cycleReveals = Number(sessionStorage.getItem('cycleReveals')||0);
  const cycleGoal = dataset.length;

  // =============================
  // Elements
  // =============================
  const els = {
    lhs: document.getElementById('lhs'),
    rhs: document.getElementById('rhs'),
    rhsPh: document.getElementById('rhsPh'),
    exlist: document.getElementById('exlist'),
    progress: document.getElementById('progress'),
    cycleFill: document.getElementById('cycleFill'),
    cycleText: document.getElementById('cycleText'),
    revealCount: document.getElementById('revealCount'),
    card: document.getElementById('card')
  };

  // =============================
  // Render
  // =============================
  function render(){
    const item = dataset[idx];

    // formula row
    els.lhs.textContent = item.lhs;
    els.rhs.textContent = item.rhs;

    const rhsShown = revealStep >= 1;
    els.rhs.style.display = rhsShown ? '' : 'none';
    els.rhsPh.style.display = rhsShown ? 'none' : '';

    // examples list
    els.exlist.innerHTML = '';
    item.examples.forEach((ex, i) => {
      const line = document.createElement('div'); line.className = 'ex-line';
      const label = document.createElement('span'); label.className='ex-label'; label.textContent = '例題:';
      const q = document.createElement('span'); q.className='ex-q'; q.textContent=ex.q;
      const eq = document.createElement('span'); eq.className='ex-eq'; eq.textContent='=';
      const a = document.createElement('span'); a.className='ex-a'; a.textContent=ex.a;
      const ph = document.createElement('span'); ph.className='ex-ph'; ph.textContent='???';
      const showAnswer = revealStep >= 2 + i; // 2 -> first example, 3 -> second, ...
      a.style.display = showAnswer ? '' : 'none';
      ph.style.display = showAnswer ? 'none' : '';
      line.appendChild(label); line.appendChild(q); line.appendChild(eq); line.appendChild(a); line.appendChild(ph);
      els.exlist.appendChild(line);
    });

    // progress UI
    els.progress.textContent = `${idx+1} / ${dataset.length}`;
    const pct = Math.min(100, (cycleReveals / cycleGoal) * 100);
    els.cycleFill.style.width = pct + '%';
    els.revealCount.textContent = String(revealTotal);
    const bar = els.cycleFill.parentElement;
    bar.setAttribute('aria-valuemax', String(cycleGoal));
    bar.setAttribute('aria-valuenow', String(cycleReveals));
    els.cycleText.textContent = `${cycleReveals} / ${cycleGoal}`;

    // MathJax typeset
    if(window.MathJax && MathJax.typesetPromise){
      MathJax.typesetPromise([document.getElementById('card')]);
    }
  }

  // =============================
  // Actions
  // =============================
  function doReveal(){
    const item = dataset[idx];
    const maxStep = 1 + item.examples.length; // RHS + each example
    if(revealStep < maxStep){
      revealStep += 1; // reveal next piece
      revealTotal += 1; localStorage.setItem('revealTotal', String(revealTotal));
      cycleReveals += 1; sessionStorage.setItem('cycleReveals', String(cycleReveals));
      if(cycleReveals >= cycleGoal){ pulseBar(); cycleReveals = 0; sessionStorage.setItem('cycleReveals', '0'); }
      render();
    } else {
      // all revealed -> next card
      idx = (idx + 1) % dataset.length;
      revealStep = 0;
      render();
    }
  }

  function prev(){
    if(revealStep > 0){
      revealStep = Math.max(0, revealStep - 1);
      render();
    } else {
      idx = (idx - 1 + dataset.length) % dataset.length;
      revealStep = 0;
      render();
    }
  }

  function pulseBar(){
    const el = els.cycleFill;
    el.animate([
      {filter:'brightness(1)'},
      {filter:'brightness(2)'},
      {filter:'brightness(1)'}
    ], {duration:600, easing:'ease-in-out'});
  }

  // =============================
  // Events
  // =============================
  els.card.addEventListener('click', doReveal);
  window.addEventListener('keydown', e=>{
    if(['Space','Enter','ArrowRight','ArrowLeft'].includes(e.code)) e.preventDefault();
    if(e.code==='Space' || e.code==='Enter' || e.code==='ArrowRight') doReveal();
    else if(e.code==='ArrowLeft') prev();
  }, {passive:false});

  // =============================
  // Tests (smoke & behavior)
  // =============================
  ;(function runTests(){
    const results = [];
    const assert = (name, cond)=>{ results.push({name, pass: !!cond}); console[cond? 'log':'error']((cond?'✅':'❌')+" "+name); };

    // Initial paint
    render();
    assert('RHS hidden initially', getComputedStyle(document.getElementById('rhs')).display === 'none');
    assert('RHS placeholder visible initially', getComputedStyle(document.getElementById('rhsPh')).display !== 'none');

    // Step 1: show formula RHS
    doReveal();
    assert('RHS visible after first reveal', getComputedStyle(document.getElementById('rhs')).display !== 'none');

    // Step 2: reveal first example answer
    doReveal();
    const firstLine = document.getElementById('exlist').firstElementChild;
    const firstAns = firstLine.querySelector('.ex-a');
    const firstPh = firstLine.querySelector('.ex-ph');
    assert('Example #1 answer visible after second reveal', getComputedStyle(firstAns).display !== 'none' && getComputedStyle(firstPh).display === 'none');

    // Step through the rest then move to next card
    const exCount = dataset[idx].examples.length;
    for(let i=1;i<exCount;i++) doReveal();
    const currentIdx = idx; doReveal(); // should advance
    assert('Advanced to next card with revealStep reset', idx !== currentIdx && revealStep === 0);

    // Integrity
    assert('Dataset has >= 11 items', dataset.length >= 11);
    assert('Each item has >= 2 examples', dataset.every(it => Array.isArray(it.examples) && it.examples.length >= 2));

    console.log('Test summary:', results);
  })();

  // Initial render
  render();
  </script>
</body>
</html>
